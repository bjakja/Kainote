<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<title>DePan</title>
<link rel="stylesheet" type="text/css" href="../../avisynth.css">
</head>
<body>
<h1>DePan & DePanEstimate</h1>
<h3>Nástroje pro odhad a kompenzaci globálního pohybu (pan - panoramování)
</h3>
<h2>Pøehled</h2>
<p><b>autor:</b> Alexander G. Balachnin aka Fizick<br>
<b>
verze:</b> 1.10.1<br>
<b>
stáhnout:</b> <a href="http://avisynth.org.ru">http://avisynth.org.ru</a>,
<A href="http://avisynth.org/warpenterprises/">http://avisynth.org/warpenterprises/</A><br>
<b>
kategorie:</b> Rùzné pluginy<br>
<b>
poadavky:</b> YV12 nebo YUY2 Barevné prostøedí<br>
<b>licence:</b> uzavøenı zdroj</p>

<h2>Úvod</h2>

<p> Tento balík obsahuje nástroje (funkce) pro odhad globálního pohybu
(pan) ve snímcích, a pro plnou nebo èásteènou globální kompenzaci pohybu.</p>
<p>Nástroje mohou bıt pouity pro:</p>
<ul>
  <li>kompenzaci globálního pohybu sousedních snímkù pro silné èasové odšumìní a restauraci klipu (filmu).</li>
  <li>obnovení znièenıch snímkù interpolací pohybu,</li>
  <li>vytvoøení sérií støedních snímkù (mezisnímkù) pro zmìnu frekvence snímkù (fps).</li>
  <li>èásteènou stabilizaci pohybu.</li>
</ul>
<p>Plugin DePan nahradil mùj experimentální GenMotion C-plugin
(kterı pouívá data pohybu z log souboru VirtualDub pluginu Deshaker).</p>
<p>Balík mùe pracovat v jednom prùchodu, obsahuje serverovou èást (funkce DePanestimate)
a jednu nebo více klientskıch èástí (funkcí nebo jejich instancí).
Serverová funkce odhaduje data pohybu snímkù a vysílá je do klientskıch funkcí na poádání.
Jako kontejner pro data pohybu se pouívá speciální sluební klip.</p>

<h2>Funkce pluginu DePanEstimate</h2>

<h3>Funkce DePanEstimate</h3>
<p>Tato fukce pouívá metodu fázového posunu (podle rychlé Fourierovy transformace)
pro kompenzaci globálního pohybu.
Pouívá nìkteré centrální oblasti kadého snímku (nebo pole) jako FFT okno pro
nalezení mezisnímkové korelace
a pro vıpoèet nejvhodnìjších hodnot vertikálního a horizontálního
posunutí, které pøizpùsobí aktuální snímek pøedchozímu.
Jako míra dùvìry je pouit nìjakı relativní korelaèní parametr a ten je také pouit pro
detekci zmìny scény.
V zoom reimu plugin pouívá levá a pravá podokna pro odhad jak
posunutí tak pøiblíení. Vıstupem je speciální sluební klip se zakódovanımi
daty pohybu ve snímcích, a volitelnì log soubor.<br>
</p>
<h4>Vızva funkce:<br>
</h4>
<p><code>DePanEstimate</code> ( <var>clip,
int range, float trust, int winx, int winy, int dxmax, int dymax, float
zoommax, bool improve, float stab, float pixaspect, bool info, string
log, bool debug, bool show, string extlog, bool fftw</var>)</p>

<h4>Parametry DePanEstimate:<br>
</h4>
<var>clip</var> - vstupní klip<br>

<var>
range</var> - poèet pøedchozích (a také následujících) snímkù (polí) poblí ádaného snímku pro odhad pohybu (celoèíselná hodnota &gt;=0, vıchozí=1)<br>
<var>trust</var> - limit relativního rozdílu maximální korelace od støední hodnoty zmìny scény (0.0 a 100.0, vıchozí=4.0)<br>
<var>winx</var> - poèet sloupcù (šíøka) fft okna (musí bıt mocninou èísla 2 &nbsp;pokud není <var>fftw</var>, vıchozí
= maximální moná (mocnina 2) šíøka uvnitø snímku).<br>

<var>
winy</var> - poèet øádkù (vıška) fft okna (musí bıt mocninou èísla 2 &nbsp;pokud není <var>fftw</var>, vıchozí
= maximální moná vıška (mocnina 2) uvnitø snímku).<br>

<var>
dxmax</var> - limit x-ového posunu (vıchozí = <var>winx</var>/4)<br>
<var>dymax</var> - limit y-ového posumu (vıchozí = <var>winy</var>/4)<br>

<var>
zoommax</var> - maximální pøibliovací (zoom) souèinitel (pokud  = 1 (vıchozí), pøiblíení není odhadováno)<br>

<var>
improve</var> - zlepší odhad pøiblíení iterováním (vıchozí = false). Od v1.6 je tento reim zrušen.<br>

<var>
stab</var> -  sniuje vypoètenou korelaci pro velká posunutí ( souèinitel typu <var>dxmax/(dxmax + stab*abs(dx))</var> ):<br>
&nbsp;&nbsp;&nbsp; = 0.0 (vıchozí)- bez sníení,<br>
&nbsp;&nbsp;&nbsp; = 1.0 - polovina <var>dxmax</var>, <var>dymax</var>.<br>

<var>
pixaspect</var> - protaení stran pixelu (vıchozí = 1.0)<br>

<var>
info</var> - zobrazí informaci o pohybu do snímku (vıchozí = false)<br>

<var>
log</var> - vysílá jméno log souboru s daty pohybu (ve formátu pluginu Deshaker z VirtualDubu) (vıchozí není, nezapisuje se)<br>

<var>
debug</var> - vysílá data pro utilitu debugview (vıchozí = false)<br>

<var>
show</var> - zobrazí korelaèní plochu (vıchozí = false)<br>

<var>
extlog</var> - vysílá jméno rozšíøeného log souboru s daty pohybu a parametru korelace (vıchozí není, nezapisuje se)<br>

<var>fftw</var> - pouije externí FFTW knihovnu (od v1.9 - vdy true)<br>
<br>
<p>Poznámky. <i>trust </i> parametry definují
nìkteré prahové hodnoty mezisnímkové podobnosti (korelace). To definuje jak podobnı musí bıt
aktuální snímek pøedchozímu snímku ve stejné scénì.
DePanEstimare detekuje zmìnu scény aktuálního snímku, pokud je aktuální
hodnota korelace níe ne prahová hodnota. Nastavte ji níe pro odvrácení chybnıch detekcí zmìny scény,
nastavte ji vıše pro odvrácení pøeskoèení skuteèné zmìny scény (s tøesením).
Vıchozí hodnota je dobrá pro vìtšinu videí, ale mùete ji testovat v <i>info</i> reimu.
</p>

<h2>Funkce pluginu DePan</h2>
<p>DePan (klient) - provádí plnou nebo èásteènou kompenzaci globálního pohybu<br>
DePanInterleave (klient) - generuje dlouhı prolínanı klip s kompenzací pohybu<br>
DePanStabilize (klient) -  stabilizuje pohyb<br>
DePanScenes(klient)
- indikuje zmìny scén</p>

<h3>DePan</h3>
<p>Generuje klip se snímky s kompenzovanım pohybem, pouitím dat pohybu, døíve vypoètenıch v
DePanEstimate.
</p>
<h4>Vızva funkce:</h4>
<p><code>DePan</code> (<var>clip, clip data, float offset, int subpixel, float pixaspect, bool matchfields, int mirror, int blur, bool info, string inputlog</var>)&nbsp; </p>
<h4>Parametry DePan:</h4>

<var>
clip</var> - vstupní klip (stejnı jako vstupní klip pro DePanEstimate)<br>

<var>
data</var> - speciální sluební klip s kódovanımi daty pohybu, vytvoøenı pomocí DePanEstimate<br>

<var>
offset</var> - hodnota kompenzace posunu (offset) pro všechny vstupní snímky (pole) (od - 10.0 do 10.0, vıchozí =0)<br>
&nbsp;&nbsp;&nbsp; = 0 je nulová transformace.<br>
&nbsp;&nbsp;&nbsp; = -1.0 je plná zpìtná kompenzace pohybu následujícího snímku (pole) k aktuálnímu,<br>
&nbsp;&nbsp;&nbsp; = 1.0 je plná dopøedná kompenzace pohybu pøedchozího snímku (pole) k aktuálnímu,<br>
&nbsp;&nbsp;&nbsp; = -0.5 je zpìtná polovièní kompenzace následujícího snímku (pole) k aktuálnímu,<br>
&nbsp;&nbsp;&nbsp; = 0.5 je dopøedná polovièní kompenzace pøedchozího snímku (pole) k aktuálnímu,<br>
&nbsp;&nbsp;&nbsp; = 0.3333333 je dopøedná tøetinová kompenzace pøedchozího snímku (pole) k aktuálnímu,<br>
&nbsp;&nbsp;&nbsp; = -1.5 je zpìtná  èásteèná kompenzace následujícího snímku po následujícím (n+2) snímku (poli) k aktuálnímu (n),<br>
&nbsp;&nbsp;&nbsp; = 2.0 je plná dopøedná kompenzace pohybu pøedchozího snímku pøedchozího snímku (n-2) (pole) k aktuálnímu (n),<br>
&nbsp;&nbsp;&nbsp; a tak dál.<br>

<var>
subpixel</var> - pøesnost interpolace pixelu (vıchozí = 2)<br>
&nbsp;&nbsp;&nbsp; 0 - pixelová pøesnost (na nejbliší pixel), ádná interpolace (rychlá),<br>
&nbsp;&nbsp;&nbsp; 1 - subpixelová pøesnost s bilineární interpolací, (optimální pro odšumìní)<br>
&nbsp;&nbsp;&nbsp; 2 - subpixelová pøesnost s bikubickou interpolací (nejlepší, ale pomalá).<br>

<var>
pixaspect</var> - protaení pixelu (vıchozí = 1.0)<br>

<var>
matchfields</var> - zarovnat vertikální pozici prokládanıch polí pro zachování poøadí polí,
lepší odšumìní atd. (vıchozí=true)<br>

<var>
mirror</var> - vyplní prázdné okraje pixely ze zrcadlovıch okrajù (namísto èernımi):<br>
&nbsp;&nbsp;&nbsp; 0 - bez zrcadlení (vıchozí);<br>
&nbsp;&nbsp;&nbsp; 1 - horní;<br>
&nbsp;&nbsp;&nbsp; 2 - spodní;<br>
&nbsp;&nbsp;&nbsp; 4 - levé;<br>
&nbsp;&nbsp;&nbsp; 8 - pravé;<br>
&nbsp;&nbsp;&nbsp; suma vıše uvedenıch - kombinace (15 - celkem ).<br>

<var>blur</var> -&nbsp; rozmazává zrcadlenou zónu pouitím dané maximální délky rozmazání (vıchozí=0,&nbsp; nerozmazávat;&nbsp;&nbsp; dobré hodnoty jsou nad 30)<br>

<var>
info</var> - zobrazuje informace o pohybu do snímku (vıchozí=false).<br>

<var>
inputlog</var> - jméno vstupního log souboru v Deshaker formátu (vıchozí - není, neète)<br>

<p>Poznámka: Parametr <var>offset</var> funkce DePan je rozšíøenou verzí parametru <var>delta</var> funkce GenMotion.</p>

<h3>DePanInterleave</h3>
<p>Generuje dlouhı prolínanı klip se sériemi skupin v poøadí: pøedchozí
snímky pohybovì kompenzované (uvnitø nìjakého rozsahu), pùvodní snímek,
následují pohybovì kompenzované snímky (uvnitø rozsahu), a stejné skupiny pro
všechny následující snímky.
Ve skuteènosti kombinuje funkci <code>DePan</code> a vnitøní AviSynth funkci <code>Interleave</code>
pro usnadnìní následujícího èasového odšumìní, s následující funkcí SelectEvery(prev+next+1, prev) pro vıbìr jen pùvodních oèištìnıch zdrojovıch snímkù.<br>
</p>
<h4>Vızva funkce:</h4>
<p><code>DePanInterleave</code> (<var>clip,
clip data, int prev, int next,&nbsp;int subpixel, float pixaspect,
bool matchfields, int mirror, int blur, bool info, string inputlog</var>)</p>
<h4>Parametry DePanInterleave jsou podobné Depan:</h4>

<var>
clip</var> - vstupní klip (stejnı jako vstupní klip pro DePanEstimate)<br>

<var>
data</var> - speciální sluební klip s kódovanımi daty pohybu, vytvoøenı pomocí DePanEstimate<br>

<var>
prev</var> - poèet pøedchozích snímkù (polí) ve skupinì pro kompenzování (celoèíselné&gt;0, vıchozí=1)<br>

<var>
next</var> - poèet následujících snímkù (polí) ve skupinì pro kompenzování (celoèíselné&gt;0, vıchozí=1)<br>

<var>
subpixel</var> - pøesnost interpolace pixelu (vıchozí = 2)<br>
&nbsp;&nbsp;&nbsp; 0 - pixelová pøesnost (na nejbliší pixel), ádná interpolace (rychlá),<br>
&nbsp;&nbsp;&nbsp; 1 - subpixelová pøesnost s bilineární interpolací, (optimální pro odšumìní)<br>
&nbsp;&nbsp;&nbsp; 2 - subpixelová pøesnost s bikubickou interpolací (nejlepší, ale pomalá).<br>
<var>
pixaspect</var> - protaení pixelu (vıchozí = 1.0)<br>

<var>
matchfields</var> - zarovnat vertikální pozici prokládanıch polí pro zachování poøadí polí,
lepší odšumìní atd. (vıchozí=true)<br>

<var>
mirror</var> - vyplní prázdné okraje pixely ze zrcadlovıch okrajù (namísto èernımi):<br>
&nbsp;&nbsp;&nbsp; 0 - bez zrcadlení (vıchozí);<br>
&nbsp;&nbsp;&nbsp; 1 - horní;<br>
&nbsp;&nbsp;&nbsp; 2 - spodní;<br>
&nbsp;&nbsp;&nbsp; 4 - levé;<br>
&nbsp;&nbsp;&nbsp; 8 - pravé;<br>
&nbsp;&nbsp;&nbsp; suma vıše uvedenıch - kombinace (15 - celkem ).<br>

<var>blur</var> -&nbsp; rozmazává zrcadlenou zónu pouitím dané maximální délky rozmazání (vıchozí=0,&nbsp; nerozmazávat;&nbsp;&nbsp; dobré hodnoty jsou nad 30)<br>

<var>
info</var> - zobrazuje informace o pohybu do snímku (vıchozí=false).<br>

<var>
inputlog</var> - jméno vstupního log souboru v Deshaker formátu (vıchozí - není, neète)<br>

<h3>DePanStabilize&nbsp;</h3>
<p>Tato funkce provádí urèitou stabilizaci obrazu (deshake) vyhlazením globálního pohybu.
Je pouita inerèní (setrvaèná) metoda (pravdìpodobnì podobná VirtualDub pluginu Digistudio).<br>
</p>
<h4>Vızva fukce:<br>
</h4>
<p><code>DePanStabilize</code> (<var>clip,
clip data, float cutoff, float damping, bool addzoom, int prev, int
next, int mirror, int blur, int dxmax, int dymax, float zoommax, float
rotmax, int subpixel, float pixaspect, &nbsp;int fitlast, float
tzoom, bool info, string inputlog, int method</var>)
</p>
<h4>Parametry funkce DePanStabilize:</h4>
<p>
<var>clip</var> - vstupní klip (stejnı jako vstupní klip pro DePanEstimate);<br>

<var>
data</var> - speciální sluební klip s kódovanımi daty pohybu, vytvoøenı pomocí DePanEstimate;<br>

<var>
cutoff</var> - frekvence oøíznutí potlaèovanıch vibrací, Hertz (vıchozí = 1.0);<br>

<var>
damping</var> - pomìr tlumení (vıchozí = 1.0);<br>

<var>initzoom</var>
- poèáteèní (minimální) pøiblíení (zoom) pro vyplnìní okrajù (vıchozí = 1.0);<br>

<var>
addzoom</var> - pouije pøídavné adaptivní pøiblíení (vıchozí=false);<br>

<var>
prev</var> -  maximální zpodìní nìkterého pøedchozího snímku pro vyplnìní prázdnıch okrajù (namísto èernıch):<br>
&nbsp;&nbsp;&nbsp; 0 - nevyplòovat (vıchozí),<br>
&nbsp;&nbsp;&nbsp; 1 - pouije nejbliší pøedchozí (n-1) snímek pro vyplnìní obrysù aktuálního snímku (n) ,<br>
&nbsp;&nbsp;&nbsp; 2 - pouije pøedchozí (n-2) snímek pro vyplnìní (ne vše v rozsahu !),<br>
&nbsp;&nbsp;&nbsp; a tak dále.<br>

<var>
next</var> - maximální zpodìní následujícího snímku pro vyplnìní prázdnıch okrajù (namísto èernıch):<br>
&nbsp;&nbsp;&nbsp; 0 - nevyplòovat (vıchozí),<br>
&nbsp;&nbsp;&nbsp; 1 - pouije nejbliší následující (n+1) snímek pro vyplnìní obrysù aktuálního snímku (n),<br>
&nbsp;&nbsp;&nbsp; 2 - pouije následující (n+2) snímek pro vyplnìní (ne vše v rozsahu !),<br>
&nbsp;&nbsp;&nbsp; a tak dále.<br>

<var>
mirror</var> - vyplní prázdné okraje pixely ze zrcadlovıch okrajù (namísto èernımi):<br>
&nbsp;&nbsp;&nbsp; 0 - bez zrcadlení (vıchozí);<br>
&nbsp;&nbsp;&nbsp; 1 - horní;<br>
&nbsp;&nbsp;&nbsp; 2 - spodní;<br>
&nbsp;&nbsp;&nbsp; 4 - levé;<br>
&nbsp;&nbsp;&nbsp; 8 - pravé;<br>
&nbsp;&nbsp;&nbsp; suma vıše uvedenıch - kombinace (15 - celkem ).<br>

<var>blur</var> -&nbsp; rozmazává zrcadlenou zónu pouitím dané maximální délky rozmazání (vıchozí=0,&nbsp; nerozmazávat;&nbsp;&nbsp; dobré hodnoty jsou nad 30)<br>

<var>
dxmax</var> - limit horizontální korekce, v pixelech (vıchozí = 60);<br>

<var>
dymax</var> - limit vertikální korekce, v pixelech (vıchozí = 30);<br>

<var>
zoommax</var> - limit korekce pøiblíení (jen adaptivní pøiblíení, vıchozí = 1.05);<br>

<var>
rotmax</var> - limit korekce rotace, ve stupních (vıchozí = 1.0);<br>

&nbsp;&nbsp;&nbsp; tyto hodnoty omezují korekci (od v1.7 - pøiblinì, ne pøísnì )<br>

<var>
subpixel</var> - pøesnost interpolace pixelu (vıchozí = 2)<br>
&nbsp;&nbsp;&nbsp; 0 - pixelová pøesnost (na nejbliší pixel), ádná interpolace (rychlá),<br>
&nbsp;&nbsp;&nbsp; 1 - subpixelová pøesnost s bilineární interpolací, (optimální pro odšumìní)<br>
&nbsp;&nbsp;&nbsp; 2 - subpixelová pøesnost s bikubickou interpolací (nejlepší, ale pomalá).<br>

<var>
pixaspect</var> - protaení pixelu (vıchozí = 1.0);<br>

<var>fitlast</var> - pøispùsobí nìkteré poslední snímky rozsahu pùvodním pozicím (celoèíselnı rozsah, vıchozí=0)<br>

<var>tzoom</var> - èas navıšení adaptivního pøibliování, v sekundách (desetinnı, vıchozí=3.0)<br>


<var>
info</var> - zobrazí informace o pohybu do snímku (vıchozí=false).<br>

<var>
inputlog</var> - jméno vstupního log souboru v Deshaker formátu (vıchozí - není, neète)<br>
<var>
method</var> - pouitá metoda pro stabilizaci:<br>
&nbsp;&nbsp;&nbsp; 0 - inerèní - setrvaèná (vıchozí);<br>
&nbsp;&nbsp;&nbsp; 1 - prùmìrná (nová od v1.10)
</p>
<h3>DePanScenes</h3>
<p>Generuje klip s hodnotou pixelu =255 pro definovanou plochu pøi zmìnì scény a hodnotách pixelù =0 v ostatních snímcích,<br>
pouitím dat pohybu vypoètenıch døíve v DePanEstimate.<br>
<br>
Mùe bıt pouit funkcí AverageLuma pro podmínìné zpracování.</p>
<h4>Vızva funkce:<br>
</h4>
<p><code>DePanScenes</code> ( <var>clip, string inputlog, int plane</var>)<br>
</p>
<h4>&nbsp;Parametry DePanScenes:</h4>
<var>clip</var> - vstupní klip (speciální sluební klip s kódovanımi daty pohybu, vytvoøenı pomocí DePanEstimate)<br>
<var>inputlog</var> - jméno vstupního log souboru v Deshaker formátu (vıchozí - není, neète)<br>
<var>plane</var> - kód plochy pro oznaèení (1 - Y, 2 - U, 4 - V, sum - kombinace, vıchozí=1)<br>
<br>

<h2>Zvláštnosti a omezení</h2>

<p>&nbsp;&nbsp; 1. Pracuje jen s YV12 a YUY2 barevnımi formáty.<br>
&nbsp;&nbsp;&nbsp; 2. Pouívá jen pohyby posunu (pan) a pøiblíení (zoom) (ne rotaci), ale
to dává pøednosti jako jsou rychlost a stabilita. Odhad v reimu zoom není velmi pøesnı.<br>
&nbsp;&nbsp;&nbsp; 3. Zdrojovı klip musí bıt shodné délky jako klip pohybovıch dat. <br>
&nbsp;&nbsp;&nbsp; 4. Pøímo pracuje jen s progresivními klipy. Pro
prokládané zdroje musíte pøed tím pouít AviSynth funkci
<code>SeparateFields</code> a pozdìji <code>Weave</code><br>
(po kompenzaci pohybu a odšumìní), s <code>AssumeTTF</code> a <code>AssumeBFF</code>
(obì mohou bıt potøeba pro posunutí lichıch polí). Plugin vyhodnocuje
poèítanı pohyb od jednoho pole k sousednímu (podle èasu) poli (od stejného
nebo následujícího snímku). Pro zachování poøadí polí (dominance) a nejlepší
odšumìní, nastavte parametr <var>MatchFields</var>=true.<br>
&nbsp;&nbsp;&nbsp; 5. <var>Mirror</var> reim je jedineènı, ale trochu divnı :-). Pouijte <var>blur</var> pro skrytí ostrıch zrcadlenıch detailù.<br>
&nbsp;&nbsp;&nbsp; 6. Ne pøíliš rychlı, bez assembler optimalizace.<br>
&nbsp;&nbsp;&nbsp; 7. Testováno s Avisynthem 2.5.3, 2.5.4, 2.5.5, 2.5.6, 2.5.7.<br>
&nbsp;&nbsp;&nbsp; 8. Staré verze DePanEstimate pouívali free FFT2D kód od Takuya Ooura
(<cite><a href="http://momonga.t.u-tokyo.ac.jp/%7Eooura/index.html">http://momonga.t.u-tokyo.ac.jp/~ooura/index.html</a></cite>)<br>
Teï DePanEstimate pouívá jen rychlejší FFTW knihovnu verze 3 (<cite><a href="http://www.fftw.org">http://www.fftw.org</a></cite>)<br>
jako Windows binární DLL (kompilovanou v gcc pod MinGW od Alessio Massaro),<br>
která podporuje vlákna a má navíc podporu AMD K7 (3dNow!) k SSE/SSE2.<br>
Mùete ho stáhnout z <cite><a href="ftp://ftp.fftw.org/pub/fftw/fftw3win32mingw.zip">ftp://ftp.fftw.org/pub/fftw/fftw3win32mingw.zip</a></cite><br>
<font color="#ff0000">Aby jste ji mohli pouít musíte vloit soubor FFTW3.DLL z tohoto balíku do nìkteré sloky na cestì pøi prozkoumávání (napøíklad C:\WINDOWS\SYSTEM32).
DePanEstimate bez toho NEPRACUJE!</font><br>
&nbsp;&nbsp;&nbsp; 9. Pro nejlepší vısledky, mùete doèasnì pøidat parametr Info, analyzovat informace a vyladit nìkteré parametry (<var>Trust</var>, <var>dxmax</var> atd).<br>
&nbsp;&nbsp;&nbsp; 10. Mùete pouít ne pøísnì stejné klipy pro
odhad pohybu a kompenzaci, napøíklad zkuste pøidat nìjakou
úpravu jasu a kontrastu, pøedfiltrování, maskování, oøíznutí
na vstupní klip pouitého jen pro odhad pohybu (a pouití jiného zpracování
pro vıstupní kompenzované-stabilizované vısledky).<br>
</p>
<h2>Pouití</h2>

<h3>Pøíprava prolínaného pohybovì kompenzovaného klipu s následnım silnım èasovım odšumìním</h3>
<p>1. Naètìte zdrojovı (vstupní) klip (I),<br>
2. Vytvoøte klip (F) s plnou dopøednou kompenzací pohybu,<br>
3. Vytvoøte klip (B) s plnou zpìtnou kompenzací pohybu,<br>
4. Vytvoøte prolínanı klip s kompenzovanımi snímky pøed a po kadém pùvodním snímku;<br>
Dostaneme dlouhı klip (s trojnásobnou délkou), s kadımi 3 posloupnımi snímky, odpovídajícími stejnému èasu.<br>
5. Aplikujte nìjakı èasovı filtr, kterı pouívá rozdíly pixelu mezi pøedchozím, aktuálním a následujícím snímkem,
napøíklad filtr Fluxsmooth.<br>
6. Vyberte kadı tøetí (pùvodní nekompenzovanı, ale oèištìnı) snímek pro vıstup.<br>
Oèištìnı klip nemá mnoho artefaktù, vytváøenıch globálním pohybem s odšumìním,
a odšumìní bude silnìjší ve vìtšinì oblastí (pohyb kamery bude kompenzován.)</p>
<p>Poznámky: s <code>DePanInterleave</code>, jsou stadia 2,3,4 spojeny do jednoho. Kromì toho mùe bıt rozsah vìtší ne 1.</p>
<h4>Jednoduchı pøíklad skriptu pro progresivní klip:</h4>

<pre>AviSource("input.avi")
LoadPlugin("depanestimate.dll") # nebo pouijte autonaèítání
LoadPlugin("depan.dll")         # nebo pouijte autonaèítání
LoadPlugin("fluxsmooth.dll")    # nebo pouijte autonaèítání

i = ConvertToYV12()
mdata = DePanEstimate(i)
DePanInterleave(i, data=mdata)
FluxSmooth()
SelectEvery(3, 1)
</pre>
<p>Pro nejlepší vısledky mùete doèasnì pøidat parametr Info, analyzovat informace a vyladit nìkteré parametry (Trust, dxmax atd.).</p>
<h4>Pøíklad skriptu pro prokládanı klip:</h4>

<pre>AviSource("input.avi")
LoadPlugin("depanestimate.dll") # nebo pouijte autonaèítání
LoadPlugin("depan.dll")         # nebo pouijte autonaèítání
LoadPlugin("fluxsmooth.dll")    # nebo pouijte autonaèítání
AssumeTFF()
SeparateFields()
i = ConvertToYV12()
mdata = DePanEstimate(i, range=1, trust=5.5, log="depan.log")
DePanInterleave(i,data=mdata, prev=1, next=1, matchfields=true)
FluxSmooth()
SelectEvery(3, 1)
Weave()
</pre>
<h4>Nìkteré vhodné èasové (temporal) odšumovací filtry<br>
</h4>
<ul>
  <li>
CTMedian (Conditional Temporal Median) od Kevina Atkinsona</li>
  <li>
  a jeho nová verze pøejmenovaná na DeSpot (od Fizick) - pro odstraòování teèek (spot)</li>
  <li>
STMedianFilter od Toma Barryho - trbarry@trbarry.com</li>
  <li>
FluxSmooth od Rosse Thomase &lt;ross@grinfinity.com&gt;</li>
  <li>
RemoveDirt od Rainera Wittmanna gorw@gmx.de</li>
  <li>DeGrainMedian od Fizick</li>
</ul>

<p>Testujte prosím pro pøidání dalších filtrù do seznamu!<br>
</p>
<p>Pro navrenou metodu odšumìní s pouitím DePan
(døíve s GenMotion),
takovı èasovı filtr musí porovnat pixel s pøedchozím a následujícím snímkem,
a udìlat nìjaké vyhlazení, pokud je mezi pøedchozím a následujícím snímkem malı rozdíl.
Tyto filtry také mohou vytvoøit dodateènou vnitøní (malou) lokální kompenzaci pohybu
(jako filtr Dust, kterı mùe získat nìjaké urychlení díky dobré globální
kompenzaci pohybu).</p>

<h3>Zmìna snímkové frekvence</h3>
<p>DePan  mùe bıt pouit jako nástroj pro pøevod frekvence snímkù a podobné úlohy.</p>
<p>Napøíklad pro zmìnu frekvence snímkù se souèinitelem=1.5, z progresivních  16.6 fps (staré 8 mm filmy) na 25 fps, pouijte skript.</p>
<pre>AviSource("kino.avi")
i = ConvertToYV12()
LoadPlugin("depanestimate.dll") # nebo pouijte autonaèítání
LoadPlugin("depan.dll")         # nebo pouijte autonaèítání
data = DePanEstimate(i, range=1, trust=5)
f1_3 = DePan(i, data, offset=1./3)
b1_3 = DePan(i, data, offset=-1./3)
Interleave(f1_3, i, b1_3)
SelectEvery(6, 0, 1, 2)
</pre>
<p>Mùe to bıt zapsáno jako funkce:

</p>
<pre>function fps2to3(clip) {
# zmìna FPS ze 2 na 3 (nebo 16.66 na 25, nebo 20 na 30 atd.), t.j. se souèinitelem=3/2
# pouije kompenzaci globálního pohybu
# vstup musí bıt YV12 nebo YUY2 progresivní (nebo pravdìpodobnì rozdìlená pole ?)
data = DePanEstimate(clip)
f1_3 = DePan(clip, data, offset=1./3)
b1_3 = DePan(clip, data, offset=-1./3)
Interleave(f1_3, clip, b1_3)
SelectEvery(6, 0, 1, 2)
}

AviSource("e:\video.avi")
LoadPlugin("depanestimate.dll") # nebo pouijte autonaèítání
LoadPlugin("depan.dll")         # nebo pouijte autonaèítání
ConvertToYV12()
fps2to3()
</pre>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;Zde je moná funkce
pro pøevod frekvence snímkù (progresivní) s faktorem=5/3, napøíklad
z 15 fps na 25 fps :

<pre>function fps3to5(clip) {
# zmìna FPS ze 3 na 5 (nebo 15 na 25, nebo 18 na 30 atd.), t.j. se souèinitelem=5/3
# pouije kompenzaci globálního pohybu
# vstup musí bıt YV12 nebo YUY2 progresivní (nebo pravdìpodobnì rozdìlená pole ?)
data = DePanEstimate(clip)
t3_5 = DePan(clip, data, offset=-2./5)
t6_5 = DePan(clip, data, offset=1./5).trim(2,0)
t9_5 = DePan(clip, data, offset=-1./5).trim(1,0)
t12_5 = DePan(clip, data, offset=2./5).trim(3,0)
Interleave(clip, t3_5, t6_5, t9_5, t12_5)
SelectEvery(15,0,1,2,3,4)
}

AviSource("e:\video.avi")
LoadPlugin("depanestimate.dll") # nebo pouijte autonaèítání
LoadPlugin("depan.dll")         # nebo pouijte autonaèítání
ConvertToYV12()
fps3to5()</pre>
<p>Poznámky. Existuje jednodušší a obecnìjší metoda:
zkuste <code>ChangeFPS</code> následovanou <code>DePanStabilize</code>.</p>

<h3>Stabilizace pohybu</h3>

<p>DePanStabilize  mùe bıt pouit jako nástroj pro vyhlazení globálního pohybu. V aktuální verzi je pouita inerèní filtraèní metoda.</p>
<p>Jednoduchı pøíklad skriptu pro progresivní klip:</p>
<pre>AviSource("input.avi")
LoadPlugin("depanestimate.dll") # nebo pouijte autonaèítání
LoadPlugin("depan.dll")         # nebo pouijte autonaèítání
i = ConvertToYV12()
mdata = DePanEstimate(i)
DePanStabilize(i, data=mdata)
</pre>
<p>Mùeme pøidat a vyladit parametry <var>cutoff</var>, <var>dxmax</var>, metodu vyplnìní prázdnıch okrajù, odpovídající vašemu klipu a vám.</p>

<h3>Detekce a logování zmìny scén</h3>
<p>Vytvoøte soubor s èísly snímkù zmìn scén. Pøehrajte celı klip.</p>
<pre>
LoadPlugin("depanestimate.dll") # nebo pouijte autonaèítání
LoadPlugin("depan.dll")         # nebo pouijte autonaèítání
filename="test.log"
avisource("g:\test.avi")
ConvertToYV12(interlaced=false)
data=DepanEstimate(trust=2.5)
WriteFileIf(filename, "(AverageLuma(DepanScenes(data))>30)" , "current_frame")
</pre>

<h3>Pouití log souborù</h3>
<p>Funkce DepanEstimate mùe zapisovat volitelnı log soubor s daty pohybu,
v Deshaker - kompatibilním formátu.
Kromì toho mùe funkce Depan èíst takové log soubory (v tomto reimu pracuje
jako GenMotion,
bez DepanEstimate, klip s daty je ignorován, a zdrojovı klip mùe bıt pouit
jako datovı klip).
Deshaker log mùe bıt naèten do Depan a naopak. Depan mùe
také kompenzovat pøiblíení (zoom) a rotaci.
Proto mùete naèíst podobné AVS skriptové soubory do VirtualDubu, a
spustit druhı prùchod Deshaker pro pokroèilou stabilizaci obrazu (a
kódování) filtrovaného klipu.
Samozøejmì, pøed tím musíte spustit první prùchod DePanEstimate pro vytvoøení
Depan.log souboru,
kterı musí bıt vybrán v Deshaker. Místo toho, mùete do skriptu pøidat funkci
DePanStabilize(i,data) a spustit vše v jednom prùchodu !</p>
<p>Od v1.9.2 je moné zapsat rozšíøenı log soubor s pøídavnımi daty "Trust" po snímku.</p>

<h3>Formát Deshaker log souboru (Gunnar Thalin)</h3>
<p>V prùbìhu 1. prùchodu zkouší plugin Deshaker najít hodnoty posunutí,
rotace a pøiblíení
které, kdy se pouijí na aktuální obraz, vytváøí to, e vypadá jako
pøedchozí obraz (témìø).
Hodnoty v kadém øádku souboru jsou (z leva do prava): èíslo snímku
(nebo èíslo pole), x- a y-posunutí (v pixelech), rotace (ve
stupních) a souèinitel pøiblíení.
Mùete log soubor upravit ruènì (ale pouijte pevnı formát øádku). Mùete smazat øádky,
které jsou úplnì špatné (i Deshaker chybuje).
Chybìjící øádky se stejnımi èísly snímkù jsou brány jako s nulovım posunem, nulovou rotací
a bez pøiblíení.
Pokud existují øádky se stejnımi èísly snímkù, pouije se poslední øádek.</p>
<p>Poznámka: Pro prokládanı zdroj je informace pro kadé pole (A - první, B - druhé v èase)</p>

<h3>Formát snímkového bufferu DePan & DepanEstimate pro klient-server (hlavnì pro programátory)</h3>
<p>Depan & DepanEstimate pouívají snímkovı buffer speciálního klipu pro uchování dat pohybu.
Kdy klient (Depan) ádá data pohybu pro snímek <code>n</code> z tohoto klipu,
server (DepanEstimate) vytvoøí snímek a zapíše do nìj taková data (na zaèátku snímkového bufferu):
jeden záznam hlavièky, a záznamy dat pohybu nìkolika snímkù, od <code>n-rozsah</code> do <code>n+rozsah</code> (<code>nsnímkù = 2*rozsah+1</code> pro ne-krajní snímky).
Definice parametrù dat pohybu je stejná jako v Deshaker logu.</p>
<p>Ve všech verzích od 0.6 pouívám tyto struktury:</p>
<pre>#define DEPANSIGNATURE "depan06"

typedef struct depanheaderstruct { // structure of header depandata in framebuffer
char signature[8]; // signature for check
int reserved; // for future using
int nframes; // number of records with frames motion data in current framebuffer
} depanheader;

typedef struct depandatastruct { // structure of every frame motion data record in framebuffer
int frame; // frame number
float dx; // x shift (in pixels) for this frame
float dy; // y shift (in pixels, corresponded to pixel aspect = 1)
float zoom; // zoom
float rot; // rotation (in degrees), (now =0 - no rotation estimated data in current version DePanEstimate)
} depandata;</pre>
<p>Poznámka 1. Depan pouívá dx=0.0 jako znaèku zmìny scény.<br>
Poznámka 2. Vıstup z DepanEstimate je oøíznut, pokud není v zobrazovacím nebo info reimu.<br>
Viz. depanio.cpp zdrojovı kód pro podrobnosti.</p>

<h3>Alternativní metoda pro odhad globálního pohybu</h3>
<p>Pøed nìjakım èasem jsem pøidal do odhadu lokálního pohybu pluginu <code>MVTools</code> od Manaa (od verze 0.9.8.2)
novou funkci <code>MVDepan</code> pro odhad globálního pohybu.
Je zaloen na analıze vektorù pohybu lokálních blokù, podobné prvnímu prùchodu v pluginu DeShaker.
Funkce <code>MVDepan</code> mùe bıt pouita místo <code>DepanEstimate</code>.
Mùe odhadovat posunutí, pøiblíení a rotaci.
</p>

<h3>Více informací o Depan</h3>
<p>Trocha diskuze o pluginech GenMotion a DePan je v AviSynth fóru na<br>
<cite><a href="http://forum.doom9.org/forumdisplay.php?s=&amp;forumid=33"> http://forum.doom9.org/forumdisplay.php?s=&amp;forumid=33</a></cite><br>
zvláš ve vláknì
<cite><a href="http://forum.doom9.org/showthread.php?s=&amp;threadid=66686"> http://forum.doom9.org/showthread.php?s=&amp;threadid=66686</a></cite></p>
<h3>Podìkování</h3>
<p>Dìkuji Gunnaru Thalinovi za detailní informaci o formátu Deshaker log souboru a velmi uiteènou diskuzi.</p>
<p>
Díky Takuyaovi Oouraovi za free a rychlı FFT2D kód pouitı v prvních verzích DePan.</p>
<p>Díky scharfis_brain a mnoha dalším za uiteènou diskuzi a zprávy o chybách.</p>

<h3>Historie verzí:</h3>
<ul>
  <li>Version 0.1, April 25, 2004 -
      first public (beta!).<br>
  </li>
  <li>Version 0.2, April 27, 2004 -
      fixed bug for non-integer <var>Offset</var> values.</li>
  <li>Version 0.3, May 15, 2004 -
      fixed bug with DePanStabilize input parameters, set <var>subpixel</var>=2 as default;<br>
      added zoom estimation and <var>ZoomMax</var> parameter, zoom and rotation compensation,
      log file input, <var>MatchFields</var> parameter.<br>
  </li>
  <li>Version 0.4, May 16, 2004
    - fixed bug with <var>MatchFields</var> for big <var>Offset</var>;<br>
fixed bug with pixel position for nearest and bilinear interpolation;<br>
set default <var>MatchFields</var>=true, add pixel aspect, Russian doc.<br>
  </li>
  <li>Version 0.5, May 22, 2004
    - fixed some bug with rotation in Depan<br>
improved DepanStabilize: changed stabilization method to inertial in wide range;<br>
added parameters <var>freqmax, dxmax, dymax, zoommax, rotmax, inputlog</var>.<br>
  </li>
  <li>Version 0.6, May 28, 2004
    - minor changed and documented client-server format.<br>
DepanEstimate: added <var>stab</var> parameter, scenechange at sharp trust changes, <var>range</var> may be 0, show correlation, crop output. <br>
DepanStabilize: <var>Freqmax</var> is renamed to <var>Cutoff</var>, add adaptive zoom, Fill.</li>
  <li>Version 0.7, May 30, 2004
    - DepanEstimate: added improve zoom estimation. <br>
  </li>
  <li>Version 0.8, June 06, 2004
    - DepanInterleave: replaced "<var>Range</var>" parameter to "<var>Prev</var>" and "<var>Next</var>".<br>
  </li>
  <li>Version 0.9, June 13, 2004
    - all clients: added "<var>Mirror</var>" parameter to fill empty borders.<br>
  </li>
  <li>Version 0.9.1, August 24, 2004 -&nbsp; Fixed bugs with zoom estimation and compensation.<br>
  </li>
  <li>Version 1.0, September 3, 2004 -&nbsp; Added option for using of external FFTW library (more fast) .<br>
  </li>
  <li>Version 1.1, September 16, 2004 -&nbsp; Added experimental DepanScenes function.<br>
  </li>
  <li>Version 1.1.1, October 07, 2004 -&nbsp; fixed bug with compensation near right bottom and top corners,<br>
&nbsp;changed from FFTW_MEASURE to FFTW_ESTIMATE for more short init, without speed change (for power-2 windows),<br>
&nbsp;compiled without /G7 flag (as before v.1.0), added FPS script functions to doc. (not public)<br>
  </li>
  <li>Version 1.1.2, October 09, 2004 -&nbsp; delayed loading of&nbsp; fftw3.dll (now optional).<br>
  </li>
  <li>Version 1.1.3, November 16, 2004 -&nbsp; fixed bug with infinite shift in DePanStabilize.<br>
  </li>
  <li>Version 1.1.4, December 15, 2004 -&nbsp; <var>damping</var>
parameter in DePanStabilize is now variable (was&nbsp; accidentally
fixed =0.9 in all previous versions :-),&nbsp;&nbsp;&nbsp;&nbsp; added
notes about MVDepan to documentation.<br>
  </li>
  <li>Version 1.1.5, December 31, 2004 -&nbsp; bug fixed in DepanEstimate (erroneous motion data)
  for <var>fftw</var>=true with <var>show</var>=false and <var>info</var>=false<br>
  </li>
  <li>Version 1.2, April 1, 2005 - added&nbsp; <var>fitlast</var> parameter to fit some last frames range to original position<br>
  </li>
  <li>Version 1.3, April 29, 2005 - added&nbsp; <var>blur</var> parameter
  to somewhat hide the sharp mirrored details;  blur is horizontal only, at left and right border.<br>
  </li>
  <li>Version 1.4, May 7, 2005 (published May 29)- DePanStabilize: Zoom adaptive mode <var>addzoom</var>
is improved.&nbsp; Adaptive zoom decreasing rate is slower than zoom
increasing rate now. Thus, the black empty borders are decreased, and
zoom value is more stable now. <br>
  </li>
  <li>Version 1.4.1, May 30, 2005 - DepanEstimate: fixed bug with log
file (A and B symbols swapped) for BFF (all previous versions). Thanks
to eugvas for report. <br>
  </li>
  <li>Version 1.5, June 4, 2005 - improved adaptive zoom;
  added <var>tzoom</var> parameter for the zoom rise time (was equal to 1/<var>cutoff</var>)<br>
  </li>
  <li>Version 1.6, August 5, 2005 - added YUY2 support; disabled <var>improved=true</var> mode (was broken);
  changed default <var>subpixel</var>=1 for DepanInterleave as sufficient for denoising and more fast<br>
  </li>
  <li>
Version 1.7, September 5, 2005 - DePanStabilize: added parameter <var>initzoom</var> - minimal zoom; <br>
changed limits <var>dxmax, dymax, zoommax, rotmax</var> from hard to soft with larger slope non-linearity.<br>
Changed cache.
  </li>
  <li>
Version 1.8, March 14, 2006 - DePanEstimate: set FFTW as default if exist, FFTW_MEASURE, little iSSE optimization<br>
DePanStabilize: added (undocumented :-) string parameters <var>vdx, vdy, vzoom, vrot</var> for AviSynth variables as requested by AI.<br>
Fixed bug with subpixel=1 YUY2 mode (memory access on refresh).
  </li>
  <li>
Version 1.8.1, May 8, 2006 - DePanStabilize: now stabilize zoom too.
  </li>
  <li>
Version 1.8.2, June 5, 2006 - DePanStabilize: now stabilize zoom on short interval;<br>
Fixed old bug with rotation.<br>
DePanEstimate: dxmax or dymax=0 now means do not estimate motion along this coordinate.
  </li>
  <li>
Version 1.8.3, June 11, 2006 - DePanStabilize: now prev and next define maximal lag.
  </li>
  <li>
Version 1.9.0, November 13, 2006 - Isolated DePanEstimate function to separate plugin DePanEstimate.dll (under GNU GPL),
removed non-fftw code (now always fftw=true).
  </li>
  <li>
Version 1.9.1, November 27, 2006 - DePanEstimate: more correct processing of dxmax=0 or dymax=0
  </li>
  <li>
DePanEstimate Version 1.9.2, March 25, 2007 - DePanEstimate: parameter <var>extlog</var>
 to write extended log file with Trust data (as requested by David).
  </li>
  <li>
DePan Version 1.10 beta, May 8, 2007 - DepanStabilize:  added new average <var>method</var>,<br>
small bug fixed in edge interpolation.
 </li>
DePan Version 1.10.1, January 27, 2008 - fixed bug with <var>blur</var> mode for <var>subpixel=1</var>.
 </li>
</ul>
<h3>Licence</h3>
<p>Plugin DePanEstimate je free software distribuovanı pod licencí GNU GPL. Viz gpl.txt pro podrobnosti.<br>
Plugin DePan je freeware, BEZ JAKÉKOLI ZÁRUKY. Nesmíte ho distribuovat bez této dokumentace.<br>
Dokumentace je distribuována pod <a href="http://creativecommons.org/licenses/by-sa/3.0/">CreativeCommons BY-SA 3.0 license.</a><br>
</p>
<p>Zvate prosím dotaci, aby jste se stali registrovanım uivatelem.</p>

<h3>Stáhnout</h3>

<p><a href="http://avisynth.org.ru/depan/depan1101.zip">Stáhnout DePan Tools verze 1.10.1</a></p>
<p><a href="http://avisynth.org.ru/depan/depanestimate192.zip">Stáhnout DePanEstimate verze 1.9.2</a></p>
		<p><kbd>$English Date: 2006/08/25 02:18:25 $</kbd></p>
	  <p><kbd>Èeskı pøeklad:23.4.2009</kbd></p>
</body>
</html>