<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<HTML>
<HEAD>
<TITLE>ColorMatrix</TITLE>
   <link rel="stylesheet" type="text/css" href="../../avisynth.css">
</HEAD>
<BODY>

<h1>ColorMatrix v2.5</h1>
<h2>Pøehled</h2>
<ul>
<b>autor:</b>    tritical
<br><b>verze:</b> v2.5<br>
<b>stáhnout:</b>   <a href="http://bengal.missouri.edu/~kes25c/">http://bengal.missouri.edu/~kes25c/</a>
<br><b>kategorie:</b>   Rùzné pluginy
<br><b>requirements:</b>&nbsp;
<ul>
  <li>YV12 &amp; YUY2 Barevné prostøedí</li>
</ul>
<p><b>licence:</b> GPL</p>
</ul>

<h2>Popis</h2>
<ul>
<P>
ColorMatrix v2.0 je založen na pùvodním filtru ColorMatrix od Wilberta Dijkhofa.
</p>
<p>
Pøi pøevodu RGB do YUV a naopak, existuje více sad koeficientù, které je možné použít.
Nejbìžnìjší jsou Rec.709, FCC, Rec.601 (aka SMPTE 170M nebo ITU-R BT.470-2), a SMPTE 240M.  Úèel
filtru ColorMatrix je pøepoèítat hodnoty YUV videa, které bylo pøevedeno z RGB použitím jedné sady
koeficientù na takové hodnoty na jaké by mìly být pøevedeny z RGB pøi použití jiné sady
koeficientù.  Dùvod proè je to užiteèné je ten, že nìkteré MPEG-2 streamy typicky používají Rec.709, zatímco vìtšina poèítaèového
softwaru (XviD/DivX dekodéry, atd...) pøedpokládají Rec.601. Proto, pokud berete MPEG-2 stream použitím Rec.709 a
pøedáte ho jako YUV do dekodéru, který nadvzorkuje do RGB použitím Rec.601 , barvy budou mírnì mimo.  V takovém pøípadì
by jste mohli použít ColorMatrix pro pøevod videa z Rec.709 do Rec.601 a jeho pøedání
dekodéru.  Další pøíklad je, pokud zachytáváte video softwarem, který používá Rec.601 a pak chcete enkódovat
do MPEG-2 použitím enkodéru, který pøedpokládá Rec.709.
</P>
<P>
Na první pohled by se zdálo, že ke splnìní svého úkolu by ColorMatrix potøeboval vnitønì
pøevést na RGB použitím zdrojových koeficientù a pak pøevést zpìt na YUV použitím nových koeficientù.
Ale není to tento pøípad. To co Colormatrix ve skuteènosti dìlá, je pøepoèítání inverzní matice (matrix) zdrojových
koeficientù (dává matici pro provedení YUV->RGB) a pak násobí takovou matici novou maticí koeficientù.
To dává sadu koeficientù pro provedení pøevodu pøímo z YUV do YUV.
</P>
<P>
ColorMatrix podporuje YV12 a YUY2 barevná prostøedí, a umí pøevádìt mezi Rec.709, FCC, Rec.601, a SMPTE 240M.
ColorMatrix je také schopen provádìt rozšíøení a zúžení rozsahu
([16,235/240]->[0,255] nebo [0,255]->[16,235/240]) jako èást pøevodu colorimetrù nebo jako samotné.
</P>
</ul>


<h3>Syntaxe</h3>
<ul>
<P>
<code>ColorMatrix </code>(clip, string <var>&quot;mode&quot;</var>, int <var>&quot;source&quot;</var>,
int <var>&quot;dest&quot;</var>, int <var>&quot;clamp&quot;</var>, bool <var>&quot;interlaced&quot;</var>,
bool <var>&quot;inputFR&quot;</var>, bool <var>&quot;outputFR&quot;</var>, bool <var>&quot;hints&quot;</var>,
string <var>&quot;d2v&quot;</var>, bool <var>&quot;debug&quot;</var>, int <var>&quot;threads&quot;</var>,
int <var>&quot;thrdmthd&quot;</var>, int <var>&quot;opt&quot;</var>)
</P>
</ul>


<h3>Parametry</h3>
<ul>


<p><var>mode</var>:</p>
<ul>
<p>Mùže být øetìzec jako <code>"source->dest"</code>, kde <code>source</code> a <code>dest</code> jsou
každý nahrazen jedním z následujících (velká písmena nevadí):</p>
<ul>
<li>Rec.709
<li>FCC
<li>Rec.601
<li>SMPTE 240M
</ul>
<p>Pøíklady:</p>
<ul>
<li>ColorMatrix(mode="Rec.709->Rec.601")
<li>ColorMatrix(mode="Rec.601->FCC")
<li>ColorMatrix(mode="SMPTE 240M->Rec.601")
<li>ColorMatrix(mode="Rec.709->FCC")
</ul>
<p><var>source</var> a <var>dest</var> nemohou být stejné jestliže <var>inputFR</var> a
<var>outputFR</var> jsou také stejné.</p>
<p>výchozí -&nbsp;&nbsp;""  (string)</p>
</ul>


<p><var>source</var>:</p>
<ul>
<p>Umožòuje nastavit zdrojový formát v celoèíselné formì.  Pokud je zadán parametr <var>mode</var>,
tak pøepíše <var>source</var>.  Možná nastavení:</p>
<ul>
<li>0 - Rec.709
<li>1 - FCC
<li>2 - Rec.601
<li>3 - SMPTE 240M
</ul>
<p>Parametry <var>source</var> a <var>dest</var> nemohou být stejné jestliže
<var>inputFR</var> a <var>outputFR</var> jsou také stejné.</p>
<p>výchozí -&nbsp;&nbsp;0  (int)</p>
</ul>


<p><var>dest</var>:</p>
<ul>
<p>Umožòuje nastavit cílový formát v celoèíselné formì.   Pokud je zadán parametr <var>mode</var>,
tak pøepíše <var>dest</var>.  Možná nastavení:</p>
<ul>
<li>0 - Rec.709
<li>1 - FCC
<li>2 - Rec.601
<li>3 - SMPTE 240M
</ul>
<p>Parametry <var>source</var> a <var>dest</var> nemohou být stejné jestliže
<var>inputFR</var> a <var>outputFR</var> jsou také stejné..</p>
<p>výchozí -&nbsp;&nbsp;2  (int)</p>
</ul>


<p><var>clamp</var>:</p>
<ul>
<p>Zadává jestli by mìlo být použito pre/post oøíznutí s omezením na 16-235/16-240.  Možná nastavení:</p>
<ul>
<li>0 - bez oøíznutí
<li>1 - oøíznutí pøed (klipu vstupujícího do ColorMatrix)
<li>2 - oøíznutí po (klipu vystupujícího z ColorMatrix)
<li>3 - oøíznutí pøed i po
</ul>
<p>3 je to, co používaly pøedchozí (v1.x) verze ColorMatrix.
<p>výchozí -&nbsp;&nbsp;3  (int)</p>
</ul>


<p><var>interlaced</var>:</p>
<ul>
<p>Prokládané video YV12 vyžaduje zvláštní zacházení... takže pokud je vaše video YV12 a je prokládané,
potøebujete nastavit tento parametr na true.  Jinak ho nechte na false.  Pro prokládané zpracování
vstupního klipu v ColorMatrix nesmí být klip založen na polích (fieldbased).  Pokud je, ColorMatrix vyhodí chybu,
která to ukáže a øekne, že by jste mìli pøed tím použít AssumeFrameBased().</p>
<p>výchozí -&nbsp;&nbsp;false  (bool)</p>
</ul>


<p><var>inputFR</var>:</p>
<ul>
<p>Øíká ColorMatrix jestli je vstupní video v plném rozsahu [0-255] nebo v omezeném rozsahu [16-235/240].
Toto nastavení nemá žádný efekt, jestliže je nastaveno stejnì jako <var>outputFR</var>. Hodnota true indikuje
plný rozsah a false indikuje omezený rozsah.</p>
<p>výchozí -&nbsp;&nbsp;false  (bool)</p>
</ul>


<p><var>outputFR</var>:</p>
<ul>
<p>Øíká ColorMatrix jestli vysílat plný rozsah [0-255] nebo omezený rozsah [16-235/240] YUV hodnot.
Toto nastavení nemá žádný efekt, jestliže je nastaveno stejnì jako <var>inputFR</var>. Hodnota true indikuje
plný rozsah a false indikuje omezený rozsah.</p>
<p>výchozí -&nbsp;&nbsp;false  (bool)</p>
</ul>


<p><var>hints</var>:</p>
<ul>
<p>
DGDecode v1.20 nebo novìjší mùže vysílat údaje (hints) colorimetry ve video streamu které mùže ColorMatrix èíst,
aby automaticky urèil zdrojové koeficienty. Pro zapnutí tohoto, nastavte <code>info=3</code> v
<code>mpeg2source()</code> a nastavte <code>hints=true</code> v <code>ColorMatrix()</code> jak je ukázáno níže:</p>
<ul><pre>Mpeg2source(&quot;F:\TestStreams\avs\AguileraGrammies.d2v&quot;, info=3)
ColorMatrix(hints=true)</pre></ul>
<p>Pokud by jste rádi zobrazily info o colorimetrech, použijte <code>info=1</code> v <code>mpeg2source()</code>
jak je ukázáno níže:</p>
<ul><pre>Mpeg2source(&quot;F:\TestStreams\avs\AguileraGrammies.d2v&quot;, info=1)</pre></ul>
<p>Pokud není ColorMatrix schopen detekovat údaje hints ve streamu (napøíklad protože používáte nesprávnou
verzi dgdecode) vyhodí chybu.  Pøi používání hints=true, pøevod zadaný parametrem <var>mode</var>
(nebo <var>source</var> a <var>dest</var> pokud není nastaven <var>mode</var>) bude aplikován jen když
colorimetry vstupního videa neodpovídají cílovým colorimetrùm. Napøíklad, pokud je <var>mode</var>
nastaven na "Rec.709->Rec.601" (nebo je <var>mode</var> ponechán prázný a <var>source</var>=0 a <var>dest</var>=2),
pak pøevod bude použit pouze pokud colorimetry vstupního videa nejsou už "Rec.601".  Pokud už odpovídají
colorimetry vstupního videa cílovým colorimetrùm, pak jsou snímky pøedány nedotknuté
(kromì pøípadu kdy omezení <var>clamp</var>>0 nebo pro rozsah pøevodu kdy <var>inputFR</var> a
<var>outputFR</var> nejsou stejné). Které scénáøe nastávají vidíte pøi použití
<var>debug</var>=true.</p>
<p>výchozí -&nbsp;&nbsp;false  (bool)</p>
</ul>


<p><var>d2v</var>:</p>
<ul>
<p>Novìjší verze DGIndexu (v1.20+) zapisují informaci o colorimetrech do d2v projektového souboru.
ColorMatrix je schopen provést rozbor d2v souboru a automaticky urèit zdrojové koeficienty z
této informace. Pro zapnutí této možnosti, nastavte parametr <var>d2v</var> roven cestì a jménu
d2v projektového souboru jak je ukázáno níže:</p>
<ul><pre>Mpeg2source(&quot;F:\TestStreams\avs\AguileraGrammies.d2v&quot;)
ColorMatrix(d2v=&quot;AguileraGrammies.d2v&quot;)</pre></ul>
<p>Pokud je d2v soubor umístìn v jiné složce než Avisynth skript budete muset zadat
plnou cestu. Operace filtru, když je parametr <var>d2v</var> zadán
je stejná jako s <var>hints</var>=true. Pokud colorimetry vstupního videa už souhlasí
s cílovými colorimetry zadanými v parametru <var>mode</var> (nebo v <var>source</var> a
<var>dest</var>), pak pøevod není aplikován. Pokud colorimetry nesouhlasí, pak je pøevod aplikován.
Použití parametru <var>d2v</var> je rychlejší než použití <var>hints</var>.</p>
<p>Je možné, že se colorimetry v klipu mìni.  Pokud je to tento pøípad, pak možnost <var>d2v</var>
bude pracovat jen když neprovádíte støih - trim() nebo nepøeuspoøádáte snímky (napøíklad ivtc) pøed výzvou ColorMatrix.  Pokud
ColorMatrix detekuje, že colorimetry v d2v souboru se mìní, bude žádat, aby èísla snímkù
zadaných v d2v souboru byl roven èíslùm snímkù ve vstupním klipu.  Možnost <var>hints</var>
nemá toto omezení.</p>
<p>Pro lidi, které to zajímá, je to tento (a následný) øádek(ky) v d2v
souboru</p>
<ul><pre>800 <b>5</b> 0 8210 0 0 32 32 92 b2 b2 a2 b2 b2 a2 b2 b2 a2</pre></ul>
<p>Zvýraznil jsem informaci o colorimetrech tuènì. Viz <a href="#colorimetry">Colorimetry</a>
pro vysvìtlující informace.</p>
<p>výchozí -&nbsp;&nbsp;""  (string)</p>
</ul>


<p><var>debug</var>:</p>
<ul>
<p>Pokud je nastaven na true, vysílá se ladící (debug) informace pøes OutputDebugString().  Mùžete použít utilitu
<a href="http://www.sysinternals.com/Utilities/DebugView.html">DebugView</a> ze Systeminternals
pro prohlížení této informace. Informace zahrnují detekované údaje (hints), použité rutiny (c, mmx, nebo sse),
atd...</p>
<p>výchozí -&nbsp;&nbsp;false  (bool)</p>
</ul>


<p><var>threads</var>:</p>
<ul>
<p>Nastavuje poèet vláken, která Colormatrix použije pro zpracování.  Mùže být jakákoli hodnota vìtší než 0 a,
pro YUY2, menší než výška snímku, pro YV12, menší než výška snímku dìlená 2.  Je-li nastaven na 0,
ColorMatrix automaticky detekuje poèet volných procesorù a nastaví threads rovno této hodnotì.</p>
<p>výchozí -&nbsp;&nbsp;1  (int)</p>
</ul>


<p><var>thrdmthd</var>:</p>
<ul>
<p>Urèuje jak bude snímek rozdìlen mezi pracující vlákna, když je threads vìtší než 1.
Možnost 0 rozdìlí snímek na sousední díly (každé vlákno bude zpracovávat blok øádkù výška/threads).
Možnost 1 rozdìlí snímek na nesousední díly (každé vlákno bude zpracovávat každý
threads - ový øádek).</p>
<p>výchozí -&nbsp;&nbsp;0  (int)</p>
</ul>


<p><var>opt</var>:</p>
<ul>
<p>Kvùli zaokrouhlování rozdílù, výstup z mmx a sse2 rutin (pøítomné jen pro YV12) není
pøesnì stejný jako výstup z c rutin (c rutina je pøesnìjší). Maximální rozdíl
mezi simd a c rutinami je +-1 na plochách Y/U/V .  Rutiny mmx a sse2
vytváøí srovnatelný výstup. Pokud nastane rozsah pøevodu (<var>inputFR</var> a <var>outputFR</var> jsou
rùzné), tak se použijí jen c rutiny.  Parametr <var>opt</var> je zahrnutý do vypnutí
použití simd optimalizací, jestliže to chcete.  Možná nastavení:</p>
<ul>
<li>0 - vynutí c rutinu
<li>1 - vynutí mmx rutinu
<li>2 - vynutí sse2 rutinu
<li>3 - auto detekce
</ul>
<p>výchozí -&nbsp;&nbsp;3  (int)</p>
</ul>
</ul>


<h2><a name="colorimetry"></a>Colorimetry</h2>
<ul>
<p>Toto je seznam všech možností v souladu s MPEG-2 specifikacemi a
DGDecode.  Sloupec úplnì vpravo ukazuje jak GSpot zkrátí každou položku.</p>
<table border="1" width="55%">
  <tr>
    <td width="10%">0</td>
    <td width="70%">zakázaný</td>
    <td width="20%">N/A</td>
  </tr>
  <tr>
    <td width="10%">1</td>
    <td width="70%">ITU-R BT.709</td>
    <td width="20%">I709</td>
  </tr>
  <tr>
    <td width="10%">2</td>
    <td width="70%">Nespecifikované video (neznámé)</td>
    <td width="20%">N/A</td>
  </tr>
  <tr>
    <td width="10%">3</td>
    <td width="70%">rezervováno</td>
    <td width="20%">N/A</td>
  </tr>
  <tr>
    <td width="10%">4</td>
    <td width="70%">FCC</td>
    <td width="20%">FCC</td>
  </tr>
  <tr>
    <td width="10%">5</td>
    <td width="70%">ITU-R BT.470-2 (pøesnì stejné jako ITU-R BT.601)</td>
    <td width="20%">I470</td>
  </tr>
  <tr>
    <td width="10%">6</td>
    <td width="70%">SMPTE 170M (pøesnì stejné jako ITU-R BT.601)</td>
    <td width="20%">S170</td>
  </tr>
  <tr>
    <td width="10%">7</td>
    <td width="70%">SMPTE 240M</td>
    <td width="20%">S240</td>
  </tr>
  <tr>
    <td width="10%">8-255</td>
    <td width="70%">rezervováno</td>
    <td width="20%">N/A</td>
  </tr>
</table>
<p>** Doporuèení BT.601 je aktualizací BT.470-2</p>
</ul>


<h2>Informace na pozadí</h2>
<ul>
<P>Existuje nìkolik zpùsobù jak pøevést YUV stream na RGB. Ten nejznámìjší
používá Rec.601 koeficienty. Ten je napøíklad použit v rutinách pøevodù barev
AviSynthu, VirtualDubu a XviD/DivX. Pøi pøehrávání XviD/DivX
je stream pøeveden na RGB použitím Rec.601 koeficientù. Hlavním problémem je, že
obèas jsou použity jiné koeficienty pro pøevod YUV do RGB (další dva jsou
koeficienty Rec.709 a FCC koeficienty). Problém nastává pokud je stream
enkódován použitím jedné sady koeficientù (napøíklad Rec.709 koeficientù pro mnohé dvd streamy),
a nìkde v øetìzci pøekomprimování-zpracování-pøehrávání je pøedpokládána odlišná
sada koeficientù (Rec.601 koeficienty pro XviD/DivX dekodér nebo
FCC koeficienty pro TMPGEnc/QuEnc nebo Rec.709 koeficienty pro CCE). Tak získáte mírnì deformované barvy, což vypadá
jako zmìna ve svìtlosti (ve skuteènosti to není zmìna svìtlosti,
barvy jsou prostì trochu mimo).
<P>Jak poznáte, která sada koeficientù je použitá
pøi enkódování MPEG-2 streamu? Obèas jsou koeficienty uchovány v hlavièce
MPEG-2 souboru (pole "matrix coefficients" v "sequence display extension").
Novìjší verze GSpot bude schopná pøeèíst tuto èást hlavièky, ale také
DGDecode (s Mpeg2source(info=1)) mùže být k tomuto použit. Pokud toto
rozšíøené pole není pøítomno v hlavièce MPEG-2 souboru, specifikace øíká, že pøedpokládáme použití výchozích
Rec.709 koeficientù.
</ul>


<h2>Odkazy</h2>
<ul>
<li><a href="http://forum.doom9.org/showthread.php?s=&amp;postid=514595#post514595">uživatelé
oznamují problém</a> - obdržení jiné svìtlosti pøi porovnání avs
skriptu s pøímým otevøením mpeg2 ve VDubMod.

<li><a href="http://forum.doom9.org/showthread.php?s=&amp;threadid=81191">informace na
pozadí</a> - vlákno na doom9 o tomto problému.

<li>pole "matrix coefficients" specifikuje sadu koeficientù danou v Tabulce 6-9 z
<a href="http://le-hacker.org/hacks/mpeg-drafts/is138182.pdf"> ISO/IEC 13818-2</a>, èást
6.3.6 (Rec.709 není zcela správná).

<li><a href="http://www.itu.int/rec/recommendation.asp?type=folders&amp;lang=e&amp;parent=R-REC-BT.709">ITU-R_BT.709</a>
- mùžete získat tøi bezplatná doporuèení na platné emailové adresy.</p>

</ul>


<h2>Seznam zmìn</h2>
<ul>
<p>v2.5, 25th January 2009<br>
  + Updated d2v parsing to correctly determine frame count for v16 DGIndex project files.<br>
  - Fixed a bug causing the mmx/sse2 routines for FCC<->Rec.601 conversions to give incorrect U plane output.<br>
</p>
<p>v2.4, 18th January 2009<br>
  - Fixed a bug causing the sse2 routines not to process the last (width&15) pixels, and the mmx routines not to process the last (width&7) pixels.<br>
</p>
<p>v2.3, 08th January 2008<br>
  - Calculate conversion coefficients for PB/PR rows from luma coefficients<br>
  - Added <var>inputFR</var> and <var>outputFR</var> parameters allowing for YUV range expansion/contraction<br>
  - Changed the <var>clamp</var> parameter from bool to int to allow specifying only pre clipping or only post clipping or both<br>
</p>
<p>v2.2, 28th August 2007<br>
  - Changed the integer <var>scaling</var> parameter to a boolean parameter named <var>clamp</var> (scaling 1/2 were redundant)<br>
  - Fixed source==dest error when using d2v or hints<br>
  - Fixed thrdmthd being switched internally (i.e. backwards versus the behaviors described in the readme)<br>
</p>
<p>v2.1, 18th January 2007<br>
  + Added multithreading support (the <var>threads</var> and <var>thrdmthd</var> parameters)<br>
  - Don't invoke AssumeFrameBased() internally during interlaced processing (requires that the input clip be framebased)<br>
</p>
<p>v2.0, 12th October 2006 (Changes from v1.10)<br>
  + Rewrote a large portion of the code<br>
  + Added ability to convert between any of: Rec.709, FCC, Rec.601, and SMPTE 240M<br>
  + Added source and dest parameters<br>
  + Added scaling parameter (optional clipping and unscaled coefficients)<br>
  + d2v option supports changing colorimetry info (with trim() and frame rearrangement restriction)<br>
  - fixed a problem with calculated luma values that were < 0 being set to 255 instead of 0
</p>
</ul>
<p><kbd>Èeský pøeklad:11.6.2009</kbd></p>
</BODY>
</HTML>
