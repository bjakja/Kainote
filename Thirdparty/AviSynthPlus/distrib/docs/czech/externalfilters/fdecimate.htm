<html>
<head>
<title>FDecimate Plugin for Avisynth</title>
<link rel="stylesheet" type="text/css" href="../../avisynth.css">
<!--
Automatically generated, don't change:
$Id: fdecimate.htm,v 1.1 2010/02/27 14:50:14 wilbertd Exp $
-->
</head>

<body>
<h1>FDecimate</h1>
<h2>Pøehled</h2>
<b>autor:</b> Donald A. Graft
<br><b>verze:</b>  1.1.0<br>
<b>stáhnout:</b> <a href="http://neuron2.net/mine.html">http://neuron2.net/mine.html</a>,
<A href="http://avisynth.org/warpenterprises/">http://avisynth.org/warpenterprises/</A><br>
<b>kategorie:</b> Odstraòování prokládání &amp; pulldown<br>
<b>poadavky:</b> YV12 &amp; YUY2 barevné prostøedí<hr>
<h3>Úvod</h3>
Filtr FDecimate() poskytuje rozšíøení decimaèních schopností, které
nejsou dostupné v Decimate(). Mùe odstraòovat snímky
z klipu pro dosaení poadované frekvence snímkù, a pøitom zachová audio/video synchronizaci.
Ppøednostnì odstraòuje duplikované snímky kde je to moné. ("FDecimate" znamená "Free Decimate",
co ukazuje, e vıstupní frekvence snímkù mùe bıt volnì vybrána, a není omezena na decimaci 1-z-N).
<p>
Stále více vídáme aplikace, kde
tradièní decimace 1-z-N není dostateèná. Ètyøi z nich zvláš
vyènívají.
<p>
První, High Definition (HD) digitální televize èasto doruèuje dvojnásobnou frekvenci snímkù, napø.,
59.94 fps pro ATSC. Progresivní film s nativní frekvencí snímkù 24 fps mùe bıt pøeveden na
HD frekvenci duplikováním snímkù podle šablony. Napøíklad pro pøevod z 24 fps na 60 fps, mùeme
pouít tuto šablonu:
<p>
A A A B B C C C D D E E E F F ...
<p>
Mùeme ji nazvat 3232... duplikaèní šablonou snímkù. Dalším pøíkladem je pøevod 25 fps na 60 fps,
kterı pouívá 3232232322... šablonu. Pøevedení z 60 fps na vysílací frekvenci
59.94 fps lze
dosáhnout buï zpomalením videa a úpravou audia pro srovnání délky, nebo
vyøazením jednoho duplikátu kadıch 1000 snímkù. V kadém pøípadì, náš koneènı stream má
hodnì duplikátù a pøístup tradièní decimace 1-z-N u dál nelze pøímo
pouívat. Obèas lze pouít nìkolik po sobì jdoucích decimací 1-z-N , ale to je tìkopádné.
A zatímco Decimate(mode=2) je uiteèná s vícenásobnımi duplikáty, není vdy úspìšná
v tomto ohledu.
<p>
Za druhé, animované filmy jsou èasto rendrovány pøi 12 fps a pøevádìny na 29.97 fps duplikováním snímkù
zpùsobem podobnım tomu popsanému vıše. Vısledek je stejnı: stream s vícenásobnımi duplikáty,
kterı není spolehlivì øešen v decimaci 1-z-N.
<p>
Za tøetí, øada nìmıch filmù je pøevádìna na DVD s pøidáváním duplikátù s
neobvyklımi šablonami, proto pùvodní frekvence snímkù nejsou 24 fps. Není
neobvyklé vidìt klipy vyadující zvláštní decimace jako 20 ze 43. Obèas
lze tìchto zvláštních decimací dosáhnout nebo témìø dosáhnout, opakovanım
pouitím Decimate() vyuívajícím rùznıch cyklù, ale to je
tìkopádnı pøístup, kterım nelze vdy dosáhnout pøesnıch decimaèních pomìrù.
FDecimate() umoòuje zadat jakoukoliv frekvenci snímkù a je proto
uiteènı pøi obnovì pùvodních natáèecích frekvencí tìchto nìmıch filmù.
<p>
Za ètvrté, obèas jsou klipy
rendrovány pøi 120 fps pro správnou pøítomnost hybridù filmu a videa. Pokud si pøejeme vrátit
normální frekeveci snímkù, potøebujeme odstranit vícenásobné duplikáty.
<p>
Filtr FDecimate() pomùe v takovıch situacích. Døívìjší filtr, MultiDecimate(), se také snail
pomoci, ale je to dvou-prùchodová implementace, která vyaduje doplòkovı externí program, a je proto
tìkopádnı. Také mohl vytváøet audio desynchronizaci, pokud nebyl pouit velmi opatrnì. Povauji
FDecimate() za lepší pøístup.
<p>
Všimnìte si prosím, e zatímco FDecimate() je moné pouít pro tradièní decimaci 1-z-N , je pro takové pouití
pravdìpodobnì lepší zùstat u Decimate() , protoe nevyaduje nastavení prahové hodnoty
detekce duplikátù, kdy se pouije v reimu mode=0.
<p>
Tato verze podporuje YUY2 a YV12 pro Avisynth 2.5.
<p>
Pokud jste zvìdaví èím se FDecimate() liší od vnitøního filtru Avisynthu ChangeFPS(), odpovìï je,
e FDecimate() mùe pøednostnì doruèit unikátní snímky, a vyhnout se duplikátùm, kde je to moné.
<p><hr>
<h3>Jak pouít FDecimate()</h3>
Pro dosaení dobrıch vısledkù je dùleité nastavit cílovou frekvenci správnì a nastavit prahovou hodnotu
pro správnou detekci duplikování. Nejdøíve uvaujme cílovou frekvenci snímkù.
<p>
<b><i>Urèení cílové frekvence snímkù </i></b> Pokud jen chcete dosáhnout známé cílové frekvence snímkù,
mùete prostì vyrazit a nastavit parametr 'rate'
na tuto frekvenci.  Napøíklad,  mùete vìdìt, e zdroj byl 24 fps film.
Ale èasto máme klip s nepravidelnou šablonou duplikátù a my nevíme, jaká by mìla cílová frekvence bıt.
To je èasto pøípad pøi zpracování starıch nìmıch filmù.
<p>
Správná frekvence snímkù mùe bıt urèena pouitím následující procedury. Najdìte úsek klipu, kterı je
asi deset sekund dlouhı a obsahuje stálı pohyb. Krokujte ve videu bez decimace a
zapište si šablonu duplikátù. Napøíklad, mohl bych vidìt toto:
<p><tt><pre>
novı obrázek následovanı jeho duplikátem
novı obrázek
novı obrázek následovanı jeho duplikátem
novı obrázek
novı obrázek následovanı jeho duplikátem
novı obrázek
...</pre></tt>
<p>
Mohl bych to zkrácenì zapsat takto: 212121... Nyní potøebujeme urèit pomìr poètu unikátních (neduplikovanıch)
obrázkù k celkovému poètu snímkù. Pro opakující se šablonu 212121 bychom mìli pomìr
2/3. Nemusíte vidìt opakující se šablonu, ale nic se nedìje. Prostì seètìte poèet unikátních obrázkù v
desetisekundové periodì a podìlte jejich poèet celkovım poètem snímkù této periody.
<p>
Dále vynásobíme pomìr urèenı vıše frekvencí snímkù nedecimovaného klipu. To dá
cílovou frekvenci snímkù, která by mìla bıt pouita, aby se odstranily všechny duplikované snímky. Mùete obdret zvláštní frekvenci snímkù,
která není standardní. Pokud vaše cílové zobrazovací zaøízení je poèítaèovı monitor, mùete vybrat
takovou zvláštní frekvenci, protoe poèítaè umí zobrazit takovou frekvenci. Ale pokud je vaším cílem
TV, budete chtít zaokrouhlit frekvenci na nejbliší standardní frekvenci. Podívejte se do následující kapitoly, "Proè FDecimate()
nemùe bıt dokonalı, a co s tím mùeme dìlat", na nìkteré
návrhy do budoucna k vıbìru cílové frekvence snímkù.
<p>
<b><i>Urèení prahové hodnoty (Threshold) pro detekci duplikátù</i></b> Pokud váš klip nemá ádné duplikáty a vy ho chcete
jednoduše decimovat na niší frekvenci snímkù, tak tento krok nepouívejte a mùete nastavit parametr
'threshold' na nulu (threshold=0). Pokud váš klip má duplikáty, chcete je pøednostnì odstranit,
a tak FDecimate() potøebuje cestu pro urèení které snímky jsou duplikáty.
<p>
Proces je následující. Pouijte filtr FDecimate() se zapnutımi metrikami:
<p><pre>FDecimate(metrics=true)</pre>
<p>
To zobrazí metriku rozdílù pro kadı snímek (decimace není pøi metrics=true vykonávána).
Prohlíejte si metriku u duplikovanıch snímkù. Potøebujete najít takové èíslo, e metrika pro všechny
duplikáty bude niší, zatímco metrika pro nové obrázky bude vyšší. Toto èíslo je
prahová hodnota, která by mìla bıt nastavena jako parametr 'threshold' . Je to obvykle nìco kolem 1.0-10.0, ale mùe se lišit
podle toho jak je váš klip zašumìlı. Je dùleité najít dobrou hodnotu pro tuto prahovou hodnotu, take to dìlejte
peèlivì a prohlíejte si pøitom nìkolik sekcí vašeho klipu.
<p>
<b><i>Vytváøení decimovaného vıstupu</i></b> Jakmile byly cílová frekvence snímkù a prahová hodnota duplikátù
stanoveny, je snadné vytvoøit koneènı decimovanı vıstup. Pøedpokládejme, e naše cílová frekvence snímkù je 20.8 fps,
a naše prahová hodnota duplikátù je 2.1, pouili bychom vızvu FDecimate() :
<p><pre>FDecimate(rate=20.8,threshold=2.1)</pre>
<p><hr><p>
<h3>Proè nemùe bıt FDecimate() dokonalı, a co s tím mùeme dìlat</h3>
Mùete shledat, e FDecimate() nepracuje dokonale s nìkterımi klipy. Napøíklad, mùe pøeskoèit snímek, nebo mùe
ponechat duplikovanı snímek. Lidé obèas pøedpokládají, e by to mìlo bıt perfektní, ale
po peèlivém zamyšlení nad tím, mùeme øíci, e dokonalost není moná pokud potøebujeme zachovat synchronní audio/video.
<p>
Myšlenka, kterou "perfekcionisti" navrhují, je jednoduše zahodit všechny duplikované snímky. Tento proces je
úspìšnı, t.j., audio/video synchronizace je zachována, pokud je šablona duplikování konzistentní. Ale pokud šablona není
konzistentní, a stává se to èasto, tak je synchronizace kompromisem. Abychom vidìli proè, uvaujme tuto šablonu
duplikování (skuteènì pozorovanou v HD klipu):
<p>
<pre>...3232323232321222212232323232...</pre>
<p>
Vìtšinu èasu je klip 323232..., co ukazuje na frekvenci 24 fps pro klip po odstranìní duplikátù
(frekvence snímkù zdroje je 59.94 fps). Ale ve støedu je šablona kde poèet duplikátù doèasnì klesá
co znamená rychlejší bázovou frekvenci snímkù. Pokud prostì vypustíme všechny duplikáty a zachováme
unikátní snímky, budeme pøehrávat tuto støední èást pøi 24 fps pøíliš pomalu. Uvìdomte si, e audio je
synchronizováno na šablonu pøed decimací, take doèasné zpomalení pøehrávání povede k audio/video desynchronizaci.
Ve skuteènosti šablona vıše zpùsobí desynchronizaci okolo 200 milisekund, co je hodnì.
Nìkolik takovıch pøípadù v øadì tak mùe zpùsobit rozdíl v sekundách!
<p>
(Další problém s myšlenkou prostého vyhození všech duplikátù je, e takové klipy mají èasto statické èásti,
kde není pohyb. Nechceme je vyhodit! Je pøedstavitelné detekovat je a pokusit se je
ušetøit ale to je dodateèná komplikace. Vánım problémem je otázka synchronizace popsaná
vıše.)
<p>
Tak mùeme vidìt, e v pøítomnosti støídání základních frekvencí snímkù kvùli nepravidelnım šablonám
duplikování, znièíme audio/video synchronizaci pokud se pokusíme pouít "dokonalı" pøístup. Všechno co mùeme opravdu
udìlat je, vynutit zadanou frekvenci, a pokusit se upøednostnit doruèení unikátních snímkù pøed
duplikáty, kde je to moné. FDecimate() pouívá tuto strategii.
<p>
Pokud máme takovı klip, ve kterém jsou náhodné èásti, kde je poèet duplikátù menší, mùeme
pøi decimování pøeskoèit dobré snímky. To zpùsobí postøehnutelné trnutí ve vıstupu. Co s tím mùeme dìlat?
Mùeme vyuít vıhodu skuteènosti, e zvláštní duplikáty jsou ménì pozorovatelné ne vynechané snímky.
Kdy nastavíme cílovou frekvenci vyšší, zachováme  více snímkù ze zdroje, a tím snííme
zmìny pøeskakování snímkù. Jistì, to zachová více duplikátù, ale je to ménì problematické.
Pro pøípad HD klipu vıše, jsem schopen nastavit frekvenci snímkù 30 fps místo 24 fps a tím
dosáhnout rozumnıch vısledkù, a pøitom mám stále standardní frekvenci snímkù.
<p>Pro úplnost pøidám tuto zvláštní poznámku. Je moné, e støídání frekvencí uvedené vıše by mohlo bıt
bipolární, t.j, nìjaké sníení základní frekvence a nìjaké její zvıšení. Zde je pøíklad:
<p>
<pre>32323232222222323232323333333332323232323...</pre>
<p>
Teoreticky bychom mohli zkusit decimovat dokonale (jak je popsáno vıše) a udret stopu vısledného audia/videa synchronní.
Dokud desynchronizace zùstává uvnitø pøijatelnıch mezí, mohli buchom vysílat "dokonalé" vısledky. Pokud
desynchronizace pøekroèí meze, mìli bychom pøeskoèit nebo duplikovat snímek. Problém tohoto
pøístupu je takovı, e v praxi nikdy nevídáme takové klipy. Co vidíme, jsou klipy se základní frekvencí
náhodnì prodìravìnou náhlımi zvıšeními frekvence (t.j., krátké periody kde není
tolik duplikátù jak se pøedpokládá podle šablony).
<p>
Proto jsem pøesvìdèenı, e neexistuje dokonalé øešení pro klipy s náhodnım støídáním základní frekvence.
Nicménì stále respektuji jakékoliv nové myšlenky, které mohou vylepšit øešení. Nestyïte se mì
kontaktovat, pokud máte nìjaké nápady pro vylepšení FDecimate().
<p><hr>
<h3>Parametry FDecimate()</h3>
Následující je syntaxe pro FDecimate() (nahraïte <i>parameter_list</i>
vaším , èárkou oddìlenım seznamem jmennıch parametrù):
<p>
<pre>FDecimate(<i>parameter_list</i>)</pre>
<p>
Zde je pøíklad:
<p><pre>FDecimate(rate=23.976,threshold=0.8,show=true)</pre>
<p><hr><p>
<b><i>rate</i></b> (desetinnı, vıchozí 23.976) Tento parametr nastavuje ádanou vıstupní frekvenci snímkù.
Pro dosaení této frekvence budou z videa odstranìny nìkteré snímky a pøitom bude zachována synchronizace audia a videa.
<p>
<b><i>threshold</i></b> (desetinnı, vıchozí 1.0) Tento parametr nastavuje prahovou hodnotu rozdílu metrik pro
detekci duplikátù. Pokud rozdíl metrik mezi dvìma snímky pøekroèí tuto hodnotu, pak tyto dva snímky
jsou povaovány za rùzné snímky, t.j., neduplikované. Podívejte se do kapitoly "Jak pouít FDecimate()" vıše
na vysvìtlení jak nastavit tuto prahovou hodnotu správnì.
<p>
<b><i>protect</i></b> (true/false, vıchozí false) Tento parametr pomáhá vyhnout se "špatnım" snímkùm po zmìnì scény. Kdy je zapnut, zvolenı vıstupní snímek je porovnán
s následujícím (ve vstupním streamu). Pokud je ten následující duplikátem zvoleného, pak je místo nìj doruèen ten následující.
<p>
<b><i>metrics</i></b> (true/false, vıchozí false) Tento parametr je pouit pro urèení správné prahové hodnoty
pouitelné pro detekci duplikátù. Kdy je nastaven na true, nedojde k ádné decimaci a rozdíl metrik kadého snímku se zobrazí
ve videu a ve vıstupu DebugView. Podívejte se do kapitoly "Jak pouít FDecimate()"
vıše na vysvìtlení jak pouít tento parametr pro nastavení správné prahové hodnoty.
<P>
<b><i>show</i></b> (true/false, vıchozí false) Tento parametr zapíná zobrazování informací ve snímku.
Také zobrazuje verzi softwaru.
<p>
Vıznamy èísel jsou následující:
<ul>
<li>blind: Volba, která by mìla bıt provedena pouitím naivní decimací, bez snahy vyhnout se doruèení duplikátù.
<li>choose: Volba, která by mìla bıt provedena pøi pokusu vyhnout se duplikátùm.
<li>use: Koneèné provedení volby. Pokud je <i>protect</i> false, tak je toto vdy stejné jako choose. Pokud je <i>protect</i> true, tak
to mùe bıt choose + 1 kdy je ochrana ve funkci.
</ul>
<p>

<b><i>debug</i></b> (true/false, vıchozí false) Tento parametr
zapíná tisk informací pøes OutputDebugString(). Pro zachycení tìchto øetìzcù je dostupná
utilita zvaná DebugView. Zobrazované informace jsou stejné jako v monosti vıše.
<p><hr><p>
<h3>Zmìna vıchozích hodnot parametrù FDecimate()</h3>
<p>Pokud
se vám nelíbí vıchozí hodnoty popsané níe, mùete si nastavit své vlastní standardní
vıchozí hodnoty. Pro pøepsání vıchozích hodnot, vytvoøte soubory vıchozích hodnot tak
jak je vyadováno ve sloce pluginù Avisynthu. Napøíklad
nastavte vıchozí threshold=2.0 pro FDecimate(), vytvoøte soubor pojmenovanı
FDecimate.def a vlote do nìj tento øádek: </p>

<p>threshold=2.0 </p>

<p>Mùete uvést tolik záznamù parametrù kolik budete chtít, na kadı øádek jeden. Ty
které nebudou zadané budou brát vıchozí hodnoty takové jaké jsou uvedeny vıše.
Samozøejmì vdy mùete pøepsat vıchozí hodnoty ve vašich skriptech, kdy vyzvete funkci.<br>
Poznámka: Øádky v souboru vıchozích hodnot nesmí obsahovat ádné mezery nebo tabulátory. </p>
<p><hr><p>
Copyright (C) 2008, Donald A. Graft, All Rights Reserved.
<p>Pro aktualizace a další filtry/nástroje, navštivte mou webovou stránku:<br>
<a href=http://neuron2.net/>http://neuron2.net/</a>
<p><kbd>$English Date: 2004/08/13 21:57:25 $</kbd></p>
<p><kbd>Èeskı pøeklad:23.3.2009</kbd></p>
</body>
</html>
