<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<HTML lang="ru">
<HEAD>
   <META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=windows-1251">
    <TITLE>ColorMatrix</TITLE>
   <link rel="stylesheet" type="text/css" href="../../avisynth.css">
</HEAD>
<BODY>
<h1>
ColorMatrix
</h1>
<h2>
Общая информация
</h2>
<b>автор:</b>    Wilbert Dijkhof и другие
<br><b>версия:</b>       1.9<br>
<b>загрузка:</b>   <a href="http://www.avisynth.org/warpenterprises/">http://www.avisynth.org/warpenterprises/</a>
<br><b>категория:</b>   Разнообразные другие плагины
<br><b>требования:</b>&nbsp;
<ul>
  <li>YV12 &amp; YUY2 цветовой формат</li>
  <li>none / MMX</li>
</ul>

<p><b>лицензия:</b> GPL</p>

<hr>

<h2>Использование</h2>

<p><code>ColorMatrix </code>(clip, string<var> &quot;mode&quot;</var>, bool <var>
&quot;interlaced&quot;</var>, bool <var> &quot;mmx&quot;</var>, bool <var> &quot;hints&quot;</var>, string
<var>
&quot;d2v&quot;</var>, bool <var> &quot;debug&quot;</var>)</p>

<h2><a name="description"></a>Описание фильтра</h2>
<P><code>ColorMatrix</code> корректирует цвета потоков MPEG-2 DVD.
Более корректно, многие MPEG-2 потоки используют слегка отличающиеся коэффициенты (называемые Rec.709)
для хранения цветовой информации, чем это делают подпрограммы преобразования цвета
AviSynth или XviD/DivX декодеры (называемые Rec.601), с тем результатом,
что клипы DivX/XviD или MPEG-2, закодированные TMPGEnc/QuEnc отображатся со слегка смещенными цветами
(что выглядит подобно небольщой разницы в яркости).
Это может быть проверено путем открытия потока MPEG-2 прямо в VirtualDubMod.</p>
<P>Данный фильтр пересчитывает YUV величины (используя
по умолчанию режим <var>mode </var>= &quot;Rec.709-&gt;Rec.601&quot;), предполагая
коэффициенты, которые используются AviSynth/VDub/DivX/XviD, со следствием,
что Ваше финальное кодирование (MPEG-2 or MPEG-4) отображается корректно. Однако, Вы
можете также использовать <var>hints</var> = true вместо указания d2v-file <var>d2v</var>
= filename, что делает коррекцию автоматически, если она необходима. Смотри <a href="#options">Опции</a>
для больщей информации.</p>
<P>В случае, если Вы захватили что-либо, или Вы имеете XviD/DivX
(оба кодированы с Rec.601 коэффициентами), и Вы хотите закодировать это в
mpeg-2 используя CCE (который предполагает Rec.709 коэффициенты),
Вы должны использовать следующий скрипт (прогрессивный материал)</p>
<pre>ColorMatrix(clip, mode=&quot;Rec.601-&gt;Rec.709&quot;)</pre>
<p>Следующий скрипт конвертирует YV12/YUY2 поток в RGB, используя Rec.709 коэффициенты
(что может быть полезно, если Вы хотите преобразовать DVD в
MPEG-2 используя TMPGEnc)</p>
<pre>ConvertToRGB(clip, matrix=&quot;Rec.709&quot;)</pre>
<P>Это должно дать те же результаты как </p>
<pre>ColorMatrix(clip, mode=&quot;Rec.601-&gt;Rec.709&quot;)
ConvertToRGB()</pre>
<p>Заключительное замечание. Данный фильтр будет  <b>поджимать=подрезать </b> (clamp=round) входное видео
 до величин, удовлетворяющих CCIR-601 (эти диапазоны есть 16-235 для компоненты яркости и 16-240 для цветности).</p>
<h3><a name="options"></a>Опции</h3>
<p><b>mode - режим (по умолчанию &quot;Rec.709-&gt;Rec.601&quot;)</b></p>
<p><var>mode</var> может быть &quot;Rec.601-&gt;Rec.709&quot; or
&quot;Rec.709-&gt;Rec.601&quot;, смотри <a href="#description">Описание данного фильтра</a>
для примеров, когда использовать эти опции. Отметьте, что эта опция будет
переопределена при использовании <var>hints</var> = true или <var>d2v</var> = filename.</p>
<p><b>interlaced (по умолчанию - false)</b></p>
<P>Для чересстрочного материала используйте
<pre>Mpeg2source(&quot;F:\TestStreams\avs\AguileraGrammies.d2v&quot;, info=3) # для dgdecode v1.20 или новее
ColorMatrix(hints=true, interlaced=true)</pre>
<pre>или если Вы не хотите использовать подсказки (hints)</pre>
<pre>Mpeg2source(&quot;F:\TestStreams\avs\AguileraGrammies.d2v&quot;)
ColorMatrix(interlaced=true)</pre>
<p><b>mmx (по умолчанию - true)</b></p>
<P>Из-за разницы округления, выход MMX (присутствует только для YV12) и C не являются точно одинаковыми.
Максимальное отличие на плоскости Y это +-2 и для UV это +-1.
Параметр <var> mmx</var> включен, чтобы отменить использование mmx-оптимизации, если вы хотите обойтись.
<pre>ColorMatrix(clip, mode=&quot;Rec.601-&gt;Rec.709&quot;, mmx=false)</pre>
<p><b>hints - подсказки (по умолчанию - false)</b></p>
<p>DGDecode v1.20 и более новые версии выводят колориметрические подсказки в видео.
Колориметрпическая информация (смотри <a href="#colorimetry">Колориметрия</a>) может быть просмотрена используя</p>
<pre>Mpeg2source(&quot;F:\TestStreams\avs\AguileraGrammies.d2v&quot;, info=1)</pre>
<p>Подсказки используются, если установлено info=3 in Mpeg2source, установлено <var>hints</var>
= true в ColorMatrix <b>и</b> если ColorMatrix используется сразу после загрузки видео</p>
<p>Mpeg2source(&quot;F:\TestStreams\avs\AguileraGrammies.d2v&quot;, info=3)<br>
ColorMatrix(hints=true)</p>
<p>Если подсказки не передаются (например из-за того что используется неверная версия
dvd2avi/dgdecode), это приведет к ошибке.</p>
<p>Технически (хотя я никогда не видет таких потоков) колориметрическая информация может быть
разной на протяжении видео, опция подсказок (hints) будет обращаться с этим корректно.</p>
<p><b>d2v</b></p>
<p>Если указывается d2v файл, то колориметрическая информация будет браться прямо из него самого.</p>
<p>Mpeg2source(&quot;F:\TestStreams\avs\AguileraGrammies.d2v&quot;)<br>
ColorMatrix(d2v=&quot;AguileraGrammies.d2v&quot;)</p>
<p>Это полезно, когда колориметрическая информация не меняется на протяжении Вашего видео
(как всегда в большинстве случаев), так как это намного быстрее чем использование подсказок. Если произойдет,
то это приведет к ошибке. Если d2v- файл помещен в другом каталоге,
 чем AviSynth скрипт, Вы должны дать полный путь к d2v-файлу.</p>
<p>Для интересующихся людей, это есть данная (и последующие) строка(и) в файле d2v</p>
<pre>800 <b>5</b> 0 8210 0 0 32 32 92 b2 b2 a2 b2 b2 a2 b2 b2 a2</pre>
<p>Я сделал колориметрическую информацию жирным шрифтом. Смотри <a href="#colorimetry">Колориметрия</a>
для объяснений этой информации.</p>
<p><b>debug - отладка</b></p>
<p>Вы можете использовать <var>debug</var> = true, чтобы проверить, что подсказки обнаруживаются.
Выводит отладочную информацию через OutputDebugString()
(используйте утилиту DebugView для просмотра этой информации).</p>
<h3><a name="colorimetry"></a>Колориметрия (Colorimetry)</h3>
<p>Это список всех возможностей согласно спецификациям mpeg-2 и
DGDecode, и  после этого как GSpot называет это</p>
<table border="1" width="50%">
  <tr>
    <td width="75%">1 ITU-R BT.709</td>
    <td width="25%">I709</td>
  </tr>
  <tr>
    <td width="75%">4 FCC (почти то же самое как ITU-R BT.601)</td>
    <td width="25%">FCC</td>
  </tr>
  <tr>
    <td width="75%">5 ITU-R BT.470-2 (точно как ITU-R BT.601)<br>
      (рекомендации BT.601 это обновление BT.470-2)</td>
    <td width="25%">I470</td>
  </tr>
  <tr>
    <td width="75%">6 SMPTE 170M (точно как ITU-R BT.601)</td>
    <td width="25%">S170</td>
  </tr>
  <tr>
    <td width="75%">7 SMPTE 240M (почти такое же как ITU-R BT.709)</td>
    <td width="25%">S240</td>
  </tr>
</table>
<p>Для ColorMatrix мы предполагаем I709 = S240 и I470=FCC=S170, так как ошибка будет очень малой.</p>

<h2>Фоновая информация</h2>
<P>Существуют несколько способов преобразования поток YUV в RGB. Наиболее хорошо известный способ
использует коэффициенты Rec.601. Это например используется в функциях цветовых преобразрваний
AviSynth, VirtualDub и XviD/DivX. При проигрывании XviD/DivX поток
преобразуется в RGB с использованием коэффициенты Rec.601. Основной вопрос в том, что
иногда используются другие коэффициенты для преобразования YUV в RGB conversion (два других есть
коэффициенты Rec.709 и коэффициенты FCC). Проблема происходит, если поток
кодируется с использованием одного набора коэффициентов (Rec.709 для многоих dvd потоков например),
и где-то в цепочке перекодирования-обработки-проигрывании предполагается другой
набор коэффициентов (Rec.601 для XviD/DivX декодера или
FCC коэффициенты для TMPGEnc/QuEnc или Rec.709 коэффициенты для CCE). Вы получите небольщое искажение цвета, которое
выглядит подобно изменению в яркости (это в действительности не является изменением яркости,
цвета просто слегка не те).</p>
<P>Как вы узнаете, какой набор коэффициентов используется
при кодировании MPEG-2 потока? Иногда коэффициенты хранятся в
заголовке MPEG-2 файла (поле "matrix coefficients" в расширении отображения последовательности  ("sequence display extension")).
Новые версии GSpot способны прочитать эту часть заголовка, но также и
DGDecode (с Mpeg2source(info=1)) может быть использовано чтобы просмотреть их. Если данное
расширенное поле не присутствует в заголовке MPEG-2 файла, спецификация говорит, что мы предполагаем использовать
по умолчанию коэффициенты Rec.709 (0.2126, 0.7152, 0.0722).</p>
<h2>Ссылки</h2>
<p><a href="http://forum.doom9.org/showthread.php?s=&amp;postid=514595#post514595">пользователи
сообщают проблему</a> - получение разной яркости при сравнении скрипта avs
с открытием mpeg2 прямо VDubMod.<br>
<a href="http://forum.doom9.org/showthread.php?s=&amp;threadid=81191">фоновая информация</a> - doom9 ветка о проблеме.<br>
Поле "matrix coefficients" указывает набор коэффициентов данный в Table 6-9
<a href="http://le-hacker.org/hacks/mpeg-drafts/is138182.pdf"> ISO/IEC 13818-2</a>, раздел
6.3.6 (Rec.709 не совсем корректен).<br>
<a href="http://www.itu.int/rec/recommendation.asp?type=folders&amp;lang=e&amp;parent=R-REC-BT.709">ITU-R_BT.709</a>
- вы можете получить три свободных рекомендации на существующий email адрес.</p>
<h2>Версии</h2>
<p>v1.9, 23th February 2005 (by tritical)</p>
<ul>
  <li>Исправлено переполнение в rec.601->rec.709 mmx преобразовании.</li>
</ul>
<p>v1.8, 13th February 2005 (by tritical)</p>
<ul>
  <li>Можно использовать подсказки от dgdecode.dll (dgdecode v1.2 и выше) если hints=true.</li>
  <li>Можно использовать информацию в d2v если задано d2v=filename.</li>
  <li>Поддержка чересстрочности (interlaced=true).</li>
  <li>Отдадочная информация (debug).</li>
</ul>
<p>v1.7, 30th January 2005 (by tritical)</p>
<ul>
  <li>mmx и другие оптимизации.</li>
</ul>
<p>v1.6, 29th January 2005 (by Wilbert)</p>
<ul>
  <li>Небольшие исправления (исправлено Rec.601->Rec.709 в режиме YV12).</li>
</ul>
<p>v1.5, 30th October 2004 (by Wilbert)</p>
<ul>
  <li>Исправлены mpeg2-коэффициенты (из ITU-R_BT.709, ISO/IEC 13818-2 слегка неверны).</li>
  <li>mpeg2-коэффициенты переименованы в Rec.709.</li>
  <li>mpeg1-коэффициенты переименованы в Rec.601.</li>
  <li>Удалено rgb=true, так как внутренняя ConvertToRGB(clip,
    matrix=&quot;Rec.709&quot;) быстрее.</li>
</ul>
<p>  	v1.4, 26th October 2004 (by Wilbert)</p>
<ul>
  <li>Добавлен режим &quot;mpeg1-&gt;mpeg2&quot; .</li>
  <li>Добавлено rgb=true, что преобразует в RGB24 используя mpeg2 коэффициенты.</li>
</ul>
<p>  	v1.3, 4th of October 2004 (by Manao)</p>
<ul>
  <li>Заменены плавающие float на целые вычисления. Почти в 2 раза быстрее.</li>
</ul>
<p>  	v1.2, 12th September 2004 (by Sh0dan)</p>
<ul>
  <li>Использованы float вместо double. Они имеют достаточную точнось и много быстрее.
  Это может однако быть изменено обратно путем змены typedef в ColorMatrix.h</li>
  <li>Более простые алгоритмы.</li>
  <li>Использован внутренний ограничитель также для выхода, вместо очень медленного if-then.</li>
  <li>Лучшее округление (добавление 0.5 для более точного преобразования float в int).</li>
</ul>
<p>  	v1.1, 12th September 2004</p>
<ul>
  <li>Использован ограничитель сначала, чтобы получить удовлетворяющее CCIR-601  цифровое видео.</li>
  <li>Также возвращает удовлетворяющее CCIR-601 цифровое видео.</li>
</ul>
<p>v1.0, 11th September 2004</p>
<ul>
  <li>Начальный выпуск.</li>
</ul>
<p><kbd>$English Date: 2005/07/10 16:11:01 $<br>
Русский перевод 02.10.2005 Fizick http://bag.hotmail.ru</kbd></p>
</BODY>
</HTML>