<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html lang="ru"><head>
  <meta http-equiv="Content-Language" content="ru">


  <meta http-equiv="Content-Type" content="text/html; charset=windows-1251">
  <title>Дискретизация</title>


  <link rel="stylesheet" type="text/css" href="../../avisynth.css">

<!--
Automatically generated, don't change: $Id: sampling.htm,v 1.4 2007/08/26 08:50:37 fizick Exp $ -->
</head>
<body style="direction: ltr;">
<h1>Дискретизация (Sampling)</h1>

<h2>1. Преобразование цветовых форматов и ошибка повышения разрешения цветности&nbsp;(Chroma Upsampling Error)</h2>

<p>Следующие рисунки показывают ошибки, которые являются примерами <b>ошибок повышения разрешения цветности (the Chroma Upsampling
Error)</b>,
называемые так потому что разрешение отсчетов (дискретизация) видео
повышено (пересчитано, интерполировано, upsampled) (от сокращенного к
более полному) некорректно
(чересстрочное&nbsp;YV12&nbsp;как прогрессивное и наоборот).
В результате Вы будете видеть промежутки на верхних и
нижних краях окрашенных объектов и строки-"призраки", плавающие выше
или ниже объектов.</p>

<table border="1" width="100%">

<tbody><tr>
<td align="center" width="100%"><img src="../pictures/advancedtopics/badchroma.jpg" border="0" height="400" width="728"></td>
</tr>
<tr>
<td align="center" width="100%">
figure 1a: пример чересстрочного источника
(YV12),&nbsp;пересчитанного с повышением разрешения как
прогрессивное видео (в YUY2)
(from http://zenaria.com/gfx/)</td>
</tr>
</tbody>
</table>

<table border="1" width="100%">

<tbody><tr>
<td align="center" width="100%"><img src="../pictures/advancedtopics/goodchroma.jpg" border="0" height="400" width="728"></td>
</tr>
<tr>
<td align="center" width="100%"> figure 1b: то же изображение с корректным пересчетом разрешения цветности
(from http://zenaria.com/gfx/)</td>
</tr>
</tbody>
</table>

<table border="1" width="100%">

<tbody><tr>
<td align="center" width="100%"><img src="../pictures/advancedtopics/badchroma2.jpg" border="0" height="400" width="720"></td>
</tr>
<tr>
<td align="center" width="100%">
figure 2a: пример прогрессивного источника (YV12)
пересчитанного&nbsp;с повышением разрешения как чересстрочное видео
(в YUY2)</td>
</tr>
</tbody>
</table>

<table border="1" width="100%">

<tbody><tr>
<td align="center" width="100%"><img src="../pictures/advancedtopics/goodchroma2.jpg" border="0" height="400" width="720"></td>
</tr>
<tr>
<td align="center" width="100%"> figure 2b: то же изображение с корректным пересчетом цветности</td>
</tr>
</tbody>
</table>

<p>В данном разделе будет показаны
причины, вызывающие эту ошибку, и как ее исправить. Здесь под исправлением
подразумевается снижение ее заметности, так как невозможно
скорректировать ее полностью.</p>

<p>Ссылки:<br>
[<a href="http://www.hometheaterhifi.com/volume_8_2/dvd-benchmark-special-report-chroma-bug-4-2001.html">The
Chroma Upsampling Error</a>]<br>
[<a href="http://members.aol.com/ajaynejr/vidbug2.htm">The Chroma Upsampling
Error - Television and Video Advice</a>]</p>

<h3>1.1 Ошибка повышения разрешения цветности (Chroma Upsampling Error&nbsp;or CUE)</h3>

<p>Как ранее утверждалось, ошибка
повышения разрешения&nbsp;цветности случается, когда Вы&nbsp; преобразуете видео из (настоящего)
чересстрочного YV12 в почти любой другой формат, но при этом преобразователь
думает, что видео является прогрессивным. Или, другой случай, если
материал прогрессивный (или чересстрочный закодированный как
прогрессивный), а пересчитан (с повышением разрешения цветности) как чересстрочный (это однако не так плохо
как первый случай).</p>

<p>При просмотре (preview) Вашего
видео&nbsp;в&nbsp;VirtualDub, он будет вынужден преобразовать
его в RGB. Так как AviSynth поставляет YV12, VirtualDub&nbsp;просит
кодек (например XviD или DivX) преобразовать YV12 в RGB. Кодек однако
ВСЕГДА пересчитывает&nbsp; прогрессивно. Отсюда Вы получите артефакты при
в просмотре VirtualDub чересстрочного материала. Это однако не
присутствует в&nbsp; YV12 видео (или в результирующем
закодированном материале). Чтобы подтвердить это,&nbsp; сделайте
преобразование с помощью AviSynth путем добавления
ConvertToRGB(interlaced=true) в конец вашего скрипта.</p>

<h3>1.2 Коррекция видео имеющего ошибку повышения разрешения цветности</h3>

<p>Вы должны будете размазать (blur) цветность каким либо способом (оставляя яркостный канал нетронутым).</p>

<p>Например (используя tomsmocomp.dll):</p>

<pre>AviSource(...)<br>MergeChroma(TomsMoComp(-1,5,0))</pre>

<h2>2. Теоретические аспекты</h2>

<p>В данном разделе будет
объяснено размещение цветности, как это относится к понижению
разрешения отсчетов (субдискретизация, подвыборка, прореживание,
subsampling) (RGB -&gt; YUY2 -&gt;
YV12) и как производится пересчет к большему разрешению (upsampling) в
AviSynth.</p>

<p>Также будет объяснено в
деталях, помечу происходит ошибка повышения разрешения цветности. Резюмируя
последнее, проблема в том, что существует разница между прогрессивным
YV12 и чересстрочным YV12, поскольку цветность разделяется (совместно
используется, shared) вертикально между соседними&nbsp;пикселами.<br>
<br>Смотри также <a href="http://forum.doom9.org/showthread.php?s=&amp;threadid=52151&amp;highlight=upsampling">
 http://forum.doom9.org/showthread.php?s=&amp;threadid=52151&amp;highlight=upsampling</a>.</p>

<h3>2.1 Цветовые форматы: RGB, YUY2 и YV12</h3>

<p>Чтобы разобраться, как работает
пересчет YV12 &lt;-&gt; YUY2 и почему имеет значение, является
ли источник чересстрочным или прогрессивным, сначала будут обсуждены
цветовые форматы YV12/YUY2. Здесь важно, как они хранятся в памяти.
Информация об этом может быть найдена здесь:
<font color="#ff0000">ColorSpaces</font>.</p>

<h4>Цветовой формат YUV 4:4:4</h4>

<p>Термин 4:4:4 обозначает, что
для каждых четырех отсчетов яркости (luminance (Y)), имеется по четыре
отсчета&nbsp; U и V. Таким образом, каждый пиксел имеет величину
яркости (Y), величину U (отсчет синей цветоразности (blue difference
sample) или Cb) и величину V&nbsp; (отсчет красной цветоразности
(red difference sample) или Cr). Отметьте, что, "C" это просто отсчет
цветности (chroma) (UV-отсчет).</p>

<p>Раскладка 4:4:4 кодированного изображения выглядит следующим образом</p>

<table border="1" width="50%">

<tbody><tr>
<td width="50%"> frame</td>
<td width="50%"> line</td>
</tr>
<tr>
<td width="50%"> YC YC YC YC</td>
<td width="50%"> line 1</td>
</tr>
<tr>
<td width="50%"> YC YC YC YC</td>
<td width="50%"> line 2</td>
</tr>
<tr>
<td width="50%"> YC YC YC YC</td>
<td width="50%"> line 3</td>
</tr>
<tr>
<td width="50%"> YC YC YC YC</td>
<td width="50%"> line 4</td>
</tr>
</tbody>
</table>

<h4>Цветовой формат YUY2</h4>

<p>YUY2 (или YUYV) есть формат
4:2:2. Термин 4:2:2 обозначает, что для каждых четырех отсчетов яркости
(luminance (Y)), имеются по два отсчета&nbsp; U и V, давая меньшую
полосу(bandwidth) цветности&nbsp;по отношению к яркости. Так, для
каждого пиксела, имеется горизонтально разделяемая (общая) UV
(цветность) с соседним пикселом.&nbsp;</p>

<p>Раскладка 4:2:2 кодированного изображения выглядит следующим образом</p>

<table border="1" width="50%">

<tbody><tr>
<td width="50%"> frame</td>
<td width="50%"> line</td>
</tr>
<tr>
<td width="50%"> YC Y YC Y</td>
<td width="50%"> line 1</td>
</tr>
<tr>
<td width="50%"> YC Y YC Y</td>
<td width="50%"> line 2</td>
</tr>
<tr>
<td width="50%"> YC Y YC Y</td>
<td width="50%"> line 3</td>
</tr>
<tr>
<td width="50%"> YC Y YC Y</td>
<td width="50%"> line 4</td>
</tr>
</tbody>
</table>

<h4>Цветовой формат YV12</h4>

<p>Для цветового формата YV12,
существуют различи между прогрессивным и чересстрочным. Причиной
является то, что величины цветности разделяются вертикально между двумя
соседними строками.</p>

<p>YV12 есть формат 4:2:0. Термин
4:2:0 обозначает, что для каждых четырех отсчетов (двух горизонтальных
и двух вертикальных) яркости (Y), имеются по одному отсчету&nbsp;U
и V, давая меньшую полосу (bandwidth) цветности по сравнению с яркостью.</p>

<p><b>Прогрессивный YV12</b></p>

<p>Для каждого
пиксела,&nbsp;горизонтально разделяется UV (цветность, chroma или
C) с соседним пикселом и вертикально разделяется UV с соседней строкой
(строка 1 со строкой 2, строка 3 со строкой 4, и т.д.).</p>

<p>Раскладка прогрессивного 4:2:0 закодированного изображения выглядит следующим образом (схему MPEG 2 - смотри ниже)</p>

<table border="1" width="50%">

<tbody><tr>
<td width="50%"> frame</td>
<td width="50%"> line</td>
</tr>
<tr>
<td width="50%">Y_Y_Y_Y</td>
<td width="50%"> line 1</td>
</tr>
<tr>
<td width="50%">C___C__</td>
<td width="50%">&nbsp;</td>
</tr>
<tr>
<td width="50%"> Y_Y_Y_Y</td>
<td width="50%"> line 2</td>
</tr>
<tr>
<td width="50%">&nbsp;</td>
<td width="50%">&nbsp;</td>
</tr>
<tr>
<td width="50%"> Y_Y_Y_Y</td>
<td width="50%">line 3</td>
</tr>
<tr>
<td width="50%"> C___C__</td>
<td width="50%">&nbsp;</td>
</tr>
<tr>
<td width="50%"> Y_Y_Y_Y</td>
<td width="50%">line 4</td>
</tr>
<tr>
<td width="50%">&nbsp;</td>
<td width="50%">&nbsp;</td>
</tr>
</tbody>
</table>

<p><b>Чересстрочный YV12</b></p>

<p>Для каждого пиксела,&nbsp;горизонтально разделяется UV (цветность,
chroma или
C) с соседним пикселом и вертикально разделяется UV со&nbsp;строкой
через одну (строка 1t со строкой 3t, строка 2b со строкой 4b, и
т.д.)&nbsp;Здесь t обозначает верхнее (top) поле, b - нижнее (bottom)
поле.</p>

<p>Раскладка чересстрочного 4:2:0 закодированного изображения выглядит следующим образом (схему MPEG 2 - смотри ниже)</p>

<table border="1" width="50%">

<tbody><tr>
<td width="50%"> frame</td>
<td width="50%"> line</td>
</tr>
<tr>
<td width="50%"> Y_Y_Y_Y</td>
<td width="50%"> line 1t</td>
</tr>
<tr>
<td width="50%"> C___C__</td>
<td width="50%">&nbsp;</td>
</tr>
<tr>
<td width="50%"> Y_Y_Y_Y</td>
<td width="50%"> line 2b</td>
</tr>
<tr>
<td width="50%">&nbsp;</td>
<td width="50%">&nbsp;</td>
</tr>
<tr>
<td width="50%"> Y_Y_Y_Y</td>
<td width="50%">line 3t</td>
</tr>
<tr>
<td width="50%"> C___C__</td>
<td width="50%">&nbsp;</td>
</tr>
<tr>
<td width="50%"> Y_Y_Y_Y</td>
<td width="50%">line 4b</td>
</tr>
<tr>
<td width="50%">&nbsp;</td>
<td width="50%">&nbsp;</td>
</tr>
</tbody>
</table>

<p>или</p>

<table border="1" width="50%">

<tbody><tr>
<td width="33%"> field 1</td>
<td width="33%"> field 2</td>
<td width="33%"> line</td>
</tr>
<tr>
<td width="33%"> Y_Y_Y_Y</td>
<td width="33%">&nbsp;</td>
<td width="33%"> line 1t</td>
</tr>
<tr>
<td width="33%"> C___C__</td>
<td width="33%">&nbsp;</td>
<td width="33%">&nbsp;</td>
</tr>
<tr>
<td width="33%">&nbsp;</td>
<td width="33%"> Y_Y_Y_Y</td>
<td width="33%"> line 2b</td>
</tr>
<tr>
<td width="33%">&nbsp;</td>
<td width="33%">&nbsp;</td>
<td width="33%">&nbsp;</td>
</tr>
<tr>
<td width="33%"> Y_Y_Y_Y</td>
<td width="33%">&nbsp;</td>
<td width="33%">line 3t</td>
</tr>
<tr>
<td width="33%">&nbsp;</td>
<td width="33%"> C___C__</td>
<td width="33%">&nbsp;</td>
</tr>
<tr>
<td width="33%">&nbsp;</td>
<td width="33%"> Y_Y_Y_Y</td>
<td width="33%">line 4b</td>
</tr>
<tr>
<td width="33%">&nbsp;</td>
<td width="33%">&nbsp;</td>
<td width="33%">&nbsp;</td>
</tr>
</tbody>
</table>

<h3>2.2 Понижение разрешения (Subsampling)</h3>

<p>Понижение разрешения отсчетов (подвыборка, прореживание, Subsampling)
используется, чтобы снизить требования по объему хранения и полосе
трансляции для цифрового видео. Это эффективно для сигнала YCbCr (яркость/синяя цветоразность/красная цветоразность), так
как человеческий глаз более чувствителен к изменениям черного и белого,
чем к изменению цвета. Так,&nbsp; радикальное сокращение цветовой информации
показывает очень небольшую видимую разницу. YUY2 и YV12 являются примерами таких&nbsp;
сокращенных (прореженных) цветовых форматов.</p>

<h4>Преобразование RGB -&gt; YUY2</h4>

<p>Больше информации о преобразованиях RGB -&gt; YUV может быть найдено здесь: <a href="color_conversions.htm">ColorConversions</a>.<br>
Повторим раскладку&nbsp;4:4:4 закодированного изображения</p>

<table border="1" width="50%">

<tbody><tr>
<td width="50%"> frame</td>
<td width="50%"> line</td>
</tr>
<tr>
<td width="50%"> YC1 YC2 YC3 YC4</td>
<td width="50%"> line 1</td>
</tr>
<tr>
<td width="50%"> YC1 YC2 YC3 YC4</td>
<td width="50%"> line 2</td>
</tr>
<tr>
<td width="50%"> YC1 YC2 YC3 YC4</td>
<td width="50%"> line 3</td>
</tr>
<tr>
<td width="50%"> YC1 YC2 YC3 YC4</td>
<td width="50%"> line 4</td>
</tr>
</tbody>
</table>

<p>В AviSynth, режим по умолчанию использует ядро (матрицу, kernel) 1-2-1 для интерполяции цветности, то есть</p>

<p>C1x = (C1+C1+C1+C2)/4 (C1 используется три раза, так как является границей)<br>
C3x = (C2+C3+C3+C4)/4<br>
C5x = (C4+C5+C5+C6)/4</p>

<p>4:2:2 закодированное изображение становится</p>

<table border="1" width="50%">

<tbody><tr>
<td width="50%"> frame</td>
<td width="50%"> line</td>
</tr>
<tr>
<td width="50%">Y1C1x Y2 Y3C3x Y4</td>
<td width="50%"> line 1</td>
</tr>
<tr>
<td width="50%">Y1C1x Y2 Y3C3x Y4</td>
<td width="50%"> line 2</td>
</tr>
<tr>
<td width="50%">Y1C1x Y2 Y3C3x Y4</td>
<td width="50%"> line 3</td>
</tr>
<tr>
<td width="50%">Y1C1x Y2 Y3C3x Y4</td>
<td width="50%"> line 4</td>
</tr>
</tbody>
</table>

<p>Другой режим <a href="../corefilters/convert.htm">ConvertBackToYUY2</a> использует цветность от левого пиксела, таким образом</p>

<table border="1" width="50%">

<tbody><tr>
<td width="50%"> frame</td>
<td width="50%"> line</td>
</tr>
<tr>
<td width="50%">Y1C1 Y2 Y3C3 Y4</td>
<td width="50%"> line 1</td>
</tr>
<tr>
<td width="50%">Y1C1 Y2 Y3C3 Y4</td>
<td width="50%"> line 2</td>
</tr>
<tr>
<td width="50%">Y1C1 Y2 Y3C3 Y4</td>
<td width="50%"> line 3</td>
</tr>
<tr>
<td width="50%">Y1C1 Y2 Y3C3 Y4</td>
<td width="50%"> line 4</td>
</tr>
</tbody>
</table>

<p><i>Отметьте (как и с раскладками других форматов) позицию величин цветности, представляющюю ВЗВЕШЕННЫЙ результат
подвыборки.</i></p>

<p><b>Преобразование чересстрочного YUY2 -&gt;&nbsp;YV12&nbsp;</b></p>

<p>Повторим раскладку чересстрочного 4:2:0 закодированного изображения, но с включенными весовыми факторами (weight):</p>

<table border="1" width="50%">

<tbody><tr>
<td width="33%">frame</td>
<td width="33%"> line</td>
<td width="33%">weights</td>
</tr>
<tr>
<td width="33%"> Y_Y_Y_Y</td>
<td width="33%"> line 1t</td>
<td width="33%">&nbsp;</td>
</tr>
<tr>
<td width="33%"> C___C__</td>
<td width="33%">&nbsp;</td>
<td width="33%"> chroma of YUY2_lines<br>
(0.75)*1t + (0.25)*3t</td>
</tr>
<tr>
<td width="33%"> Y_Y_Y_Y</td>
<td width="33%"> line 2b</td>
<td width="33%">&nbsp;</td>
</tr>
<tr>
<td width="33%">&nbsp;</td>
<td width="33%">&nbsp;</td>
<td width="33%">&nbsp;</td>
</tr>
<tr>
<td width="33%"> Y_Y_Y_Y</td>
<td width="33%">line 3t</td>
<td width="33%">&nbsp;</td>
</tr>
<tr>
<td width="33%"> C___C__</td>
<td width="33%">&nbsp;</td>
<td width="33%"> chroma of YUY2_lines<br>
(0.25)*2b + (0.75)*4b</td>
</tr>
<tr>
<td width="33%"> Y_Y_Y_Y</td>
<td width="33%">line 4b</td>
<td width="33%">&nbsp;</td>
</tr>
<tr>
<td width="33%">&nbsp;</td>
<td width="33%">&nbsp;</td>
<td width="33%">&nbsp;</td>
</tr>
</tbody>
</table>

<p>или</p>

<table border="1" width="50%">

<tbody><tr>
<td width="25%"> field 1</td>
<td width="25%"> field 2</td>
<td width="25%"> line</td>
<td width="25%">weights</td>
</tr>
<tr>
<td width="25%"> Y_Y_Y_Y</td>
<td width="25%">&nbsp;</td>
<td width="25%"> line 1t</td>
<td width="25%">&nbsp;</td>
</tr>
<tr>
<td width="25%"> C___C__</td>
<td width="25%">&nbsp;</td>
<td width="25%">&nbsp;</td>
<td width="25%"> chroma of YUY2_lines<br>
(0.75)*1t + (0.25)*3t</td>
</tr>
<tr>
<td width="25%">&nbsp;</td>
<td width="25%"> Y_Y_Y_Y</td>
<td width="25%"> line 2b</td>
<td width="25%">&nbsp;</td>
</tr>
<tr>
<td width="25%">&nbsp;</td>
<td width="25%">&nbsp;</td>
<td width="25%">&nbsp;</td>
<td width="25%">&nbsp;</td>
</tr>
<tr>
<td width="25%"> Y_Y_Y_Y</td>
<td width="25%">&nbsp;</td>
<td width="25%">line 3t</td>
<td width="25%">&nbsp;</td>
</tr>
<tr>
<td width="25%">&nbsp;</td>
<td width="25%"> C___C__</td>
<td width="25%">&nbsp;</td>
<td width="25%"> chroma of YUY2_lines<br>
(0.25)*2b + (0.75)*4b</td>
</tr>
<tr>
<td width="25%">&nbsp;</td>
<td width="25%"> Y_Y_Y_Y</td>
<td width="25%">line 4b</td>
<td width="25%">&nbsp;</td>
</tr>
<tr>
<td width="25%">&nbsp;</td>
<td width="25%">&nbsp;</td>
<td width="25%">&nbsp;</td>
<td width="25%">&nbsp;</td>
</tr>
</tbody>
</table>

<p><i>Отметьте (как и с раскладками других форматов) позицию величин цветности, представляющую ВЗВЕШЕННЫЙ результат
подвыборки.</i></p>

<p>Таким образом, цветность (chroma) растянута через две строки яркости в том же поле (полукадре)!</p>

<p><b>Преобразование прогрессивного YUY2 -&gt; YV12&nbsp;</b></p>

<p>Повторим раскладку 4:2:0 закодированного изображения</p>

<table border="1" width="50%">

<tbody><tr>
<td width="33%">frame</td>
<td width="33%"> line</td>
<td width="33%">weights</td>
</tr>
<tr>
<td width="33%"> Y_Y_Y_Y</td>
<td width="33%"> line 1</td>
<td width="33%">&nbsp;</td>
</tr>
<tr>
<td width="33%"> C___C__</td>
<td width="33%">&nbsp;</td>
<td width="33%"> chroma of YUY2_lines<br>
(0.5)*1 + (0.5)*2</td>
</tr>
<tr>
<td width="33%"> Y_Y_Y_Y</td>
<td width="33%"> line 2</td>
<td width="33%">&nbsp;</td>
</tr>
<tr>
<td width="33%">&nbsp;</td>
<td width="33%">&nbsp;</td>
<td width="33%">&nbsp;</td>
</tr>
<tr>
<td width="33%"> Y_Y_Y_Y</td>
<td width="33%">line 3</td>
<td width="33%">&nbsp;</td>
</tr>
<tr>
<td width="33%"> C___C__</td>
<td width="33%">&nbsp;</td>
<td width="33%"> chroma of YUY2_lines<br>
(0.5)*3 + (0.5)*4</td>
</tr>
<tr>
<td width="33%"> Y_Y_Y_Y</td>
<td width="33%">line 4</td>
<td width="33%">&nbsp;</td>
</tr>
<tr>
<td width="33%">&nbsp;</td>
<td width="33%">&nbsp;</td>
<td width="33%">&nbsp;</td>
</tr>
</tbody>
</table>

<p><i>Отметьте (как и с раскладками других форматов) позицию величин цветности, представляющюю ВЗВЕШЕННЫЙ результат
подвыборки.</i></p>

<p>Таким образом, цветность (chroma) растянута через две строки в том же (полном) кадре!</p>

<h3>2.3 Повышение разрешения (Upsampling)</h3>

<h4>Преобразование YUY2 -&gt; RGB</h4>

<p>Повторим раскладку 4:2:2 закодированного изображения</p>

<table border="1" width="50%">

<tbody><tr>
<td width="50%"> frame</td>
<td width="50%"> line</td>
</tr>
<tr>
<td width="50%">Y1C1 Y2 Y3C3 Y4</td>
<td width="50%"> line 1</td>
</tr>
<tr>
<td width="50%">Y1C1 Y2 Y3C3 Y4</td>
<td width="50%"> line 2</td>
</tr>
<tr>
<td width="50%">Y1C1 Y2 Y3C3 Y4</td>
<td width="50%"> line 3</td>
</tr>
<tr>
<td width="50%">Y1C1 Y2 Y3C3 Y4</td>
<td width="50%"> line 4</td>
</tr>
</tbody>
</table>

<p>Для преобразования 4:2:2
-&gt; 4:4:4, пропущенные (недостающие) отсчеты цветности
интерполируются (используя ядро 1-1), то есть</p>

<p>C2x = (C1+C3)/2<br>
C4x = (C3+C5)/2</p>

<p>а существующие отсчеты цветности просто копируются.</p>

<p>4:4:4 закодированное изображение становится</p>

<table border="1" width="50%">

<tbody><tr>
<td width="50%"> frame</td>
<td width="50%"> line</td>
</tr>
<tr>
<td width="50%">Y1C1 Y2C2x Y3C3 Y4C4x</td>
<td width="50%"> line 1</td>
</tr>
<tr>
<td width="50%">Y1C1 Y2C2x Y3C3 Y4C4x</td>
<td width="50%"> line 2</td>
</tr>
<tr>
<td width="50%">Y1C1 Y2C2x Y3C3 Y4C4x</td>
<td width="50%"> line 3</td>
</tr>
<tr>
<td width="50%">Y1C1 Y2C2x Y3C3 Y4C4x</td>
<td width="50%"> line 4</td>
</tr>
</tbody>
</table>

<h4>Преобразование чересстрочного YV12&nbsp; -&gt; YUY2</h4>

<p>В&nbsp;AviSynth, пропущенные (недостающие) отсчеты цветности интерполируются следующим образом</p>

<table border="1" width="50%">

<tbody><tr>
<td width="33%">frame</td>
<td width="33%"> line</td>
<td width="33%">weights</td>
</tr>
<tr>
<td width="33%"> Y_Y_Y_Y</td>
<td width="33%"> line 1t</td>
<td width="33%"> chroma of YV12_lines<br>
1t</td>
</tr>
<tr>
<td width="33%"> C___C__</td>
<td width="33%">&nbsp;</td>
<td width="33%">&nbsp;</td>
</tr>
<tr>
<td width="33%"> Y_Y_Y_Y</td>
<td width="33%"> line 2b</td>
<td width="33%"> chroma of YV12_lines<br>
4b</td>
</tr>
<tr>
<td width="33%">&nbsp;</td>
<td width="33%">&nbsp;</td>
<td width="33%">&nbsp;</td>
</tr>
<tr>
<td width="33%"> Y_Y_Y_Y</td>
<td width="33%">line 3t</td>
<td width="33%"> chroma of YV12_lines<br>
(0.75)*1t + (0.25)*5t</td>
</tr>
<tr>
<td width="33%"> C___C__</td>
<td width="33%">&nbsp;</td>
<td width="33%">&nbsp;</td>
</tr>
<tr>
<td width="33%"> Y_Y_Y_Y</td>
<td width="33%">line 4b</td>
<td width="33%"> chroma of YV12_lines<br>
(0.75)*4b + (0.25)*8b</td>
</tr>
<tr>
<td width="33%">&nbsp;</td>
<td width="33%">&nbsp;</td>
<td width="33%">&nbsp;</td>
</tr>
<tr>
<td width="33%"> Y_Y_Y_Y</td>
<td width="33%"> line 5t</td>
<td width="33%"> chroma of YV12_lines<br>
(0.25)*1t + (0.75)*5t</td>
</tr>
<tr>
<td width="33%"> C___C__</td>
<td width="33%">&nbsp;</td>
<td width="33%">&nbsp;</td>
</tr>
<tr>
<td width="33%"> Y_Y_Y_Y</td>
<td width="33%"> line 6b</td>
<td width="33%"> chroma of YV12_lines<br>
(0.25)*4b + (0.75)*8b</td>
</tr>
<tr>
<td width="33%">&nbsp;</td>
<td width="33%">&nbsp;</td>
<td width="33%">&nbsp;</td>
</tr>
<tr>
<td width="33%"> Y_Y_Y_Y</td>
<td width="33%"> line 7t</td>
<td width="33%"> chroma of YV12_lines<br>
(0.75)*5t + (0.25)*9t</td>
</tr>
<tr>
<td width="33%"> C___C__</td>
<td width="33%">&nbsp;</td>
<td width="33%">&nbsp;</td>
</tr>
<tr>
<td width="33%"> Y_Y_Y_Y</td>
<td width="33%"> line 8b</td>
<td width="33%"> chroma of YV12_lines<br>
(0.75)*8b + (0.25)*12b</td>
</tr>
<tr>
<td width="33%">&nbsp;</td>
<td width="33%">&nbsp;</td>
<td width="33%">&nbsp;</td>
</tr>
</tbody>
</table>

<p>или</p>

<table border="1" width="50%">

<tbody><tr>
<td width="25%"> field 1</td>
<td width="25%"> field 2</td>
<td width="25%"> line</td>
<td width="25%">weights</td>
</tr>
<tr>
<td width="25%"> Y_Y_Y_Y</td>
<td width="25%">&nbsp;</td>
<td width="25%"> line 1t</td>
<td width="25%"> chroma of YV12_lines<br>
1t</td>
</tr>
<tr>
<td width="25%"> C___C__</td>
<td width="25%">&nbsp;</td>
<td width="25%">&nbsp;</td>
<td width="25%">&nbsp;</td>
</tr>
<tr>
<td width="25%">&nbsp;</td>
<td width="25%"> Y_Y_Y_Y</td>
<td width="25%"> line 2b</td>
<td width="25%"> chroma of YV12_lines<br>
4b</td>
</tr>
<tr>
<td width="25%">&nbsp;</td>
<td width="25%">&nbsp;</td>
<td width="25%">&nbsp;</td>
<td width="25%">&nbsp;</td>
</tr>
<tr>
<td width="25%"> Y_Y_Y_Y</td>
<td width="25%">&nbsp;</td>
<td width="25%">line 3t</td>
<td width="25%"> chroma of YV12_lines<br>
(0.75)*1t + (0.25)*5t</td>
</tr>
<tr>
<td width="25%">&nbsp;</td>
<td width="25%"> C___C__</td>
<td width="25%">&nbsp;</td>
<td width="25%">&nbsp;</td>
</tr>
<tr>
<td width="25%">&nbsp;</td>
<td width="25%"> Y_Y_Y_Y</td>
<td width="25%">line 4b</td>
<td width="25%"> chroma of YV12_lines<br>
(0.75)*4b + (0.25)*8b</td>
</tr>
<tr>
<td width="25%">&nbsp;</td>
<td width="25%">&nbsp;</td>
<td width="25%">&nbsp;</td>
<td width="25%">&nbsp;</td>
</tr>
<tr>
<td width="25%"> Y_Y_Y_Y</td>
<td width="25%">&nbsp;</td>
<td width="25%">line 5t</td>
<td width="25%"> chroma of YV12_lines<br>
(0.25)*1t + (0.75)*5t</td>
</tr>
<tr>
<td width="25%"> C___C__</td>
<td width="25%">&nbsp;</td>
<td width="25%">&nbsp;</td>
<td width="25%">&nbsp;</td>
</tr>
<tr>
<td width="25%">&nbsp;</td>
<td width="25%"> Y_Y_Y_Y</td>
<td width="25%">line 6b</td>
<td width="25%"> chroma of YV12_lines<br>
(0.25)*4b + (0.75)*8b</td>
</tr>
<tr>
<td width="25%">&nbsp;</td>
<td width="25%">&nbsp;</td>
<td width="25%">&nbsp;</td>
<td width="25%">&nbsp;</td>
</tr>
<tr>
<td width="25%"> Y_Y_Y_Y</td>
<td width="25%">&nbsp;</td>
<td width="25%">line 7t</td>
<td width="25%"> chroma of YV12_lines<br>
(0.75)*5t + (0.25)*9t</td>
</tr>
<tr>
<td width="25%">&nbsp;</td>
<td width="25%"> C___C__</td>
<td width="25%">&nbsp;</td>
<td width="25%">&nbsp;</td>
</tr>
<tr>
<td width="25%">&nbsp;</td>
<td width="25%"> Y_Y_Y_Y</td>
<td width="25%">line 8b</td>
<td width="25%"> chroma of YV12_lines<br>
(0.75)*8b + (0.25)*12b</td>
</tr>
<tr>
<td width="25%">&nbsp;</td>
<td width="25%">&nbsp;</td>
<td width="25%">&nbsp;</td>
<td width="25%">&nbsp;</td>
</tr>
</tbody>
</table>

<p>AviSynth использует иную
интерполяцию, чем предложеную спецификацией mpeg2&nbsp;(возможно
из-за проблем скорости). Последняя (MPEG2) есть</p>

<table border="1" width="50%">

<tbody><tr>
<td width="25%"> field 1</td>
<td width="25%"> field 2</td>
<td width="25%"> line</td>
<td width="25%">weights</td>
</tr>
<tr>
<td width="25%"> Y_Y_Y_Y</td>
<td width="25%">&nbsp;</td>
<td width="25%"> line 1t</td>
<td width="25%"> chroma of YV12_lines<br>
1t</td>
</tr>
<tr>
<td width="25%"> C___C__</td>
<td width="25%">&nbsp;</td>
<td width="25%">&nbsp;</td>
<td width="25%">&nbsp;</td>
</tr>
<tr>
<td width="25%">&nbsp;</td>
<td width="25%"> Y_Y_Y_Y</td>
<td width="25%"> line 2b</td>
<td width="25%"> chroma of YV12_lines<br>
4b</td>
</tr>
<tr>
<td width="25%">&nbsp;</td>
<td width="25%">&nbsp;</td>
<td width="25%">&nbsp;</td>
<td width="25%">&nbsp;</td>
</tr>
<tr>
<td width="25%"> Y_Y_Y_Y</td>
<td width="25%">&nbsp;</td>
<td width="25%">line 3t</td>
<td width="25%"> chroma of YV12_lines<br>
(5/8)*1t + (3/8)*5t</td>
</tr>
<tr>
<td width="25%">&nbsp;</td>
<td width="25%"> C___C__</td>
<td width="25%">&nbsp;</td>
<td width="25%">&nbsp;</td>
</tr>
<tr>
<td width="25%">&nbsp;</td>
<td width="25%"> Y_Y_Y_Y</td>
<td width="25%">line 4b</td>
<td width="25%"> chroma of YV12_lines<br>
(7/8)*4b + (1/8)*8b</td>
</tr>
<tr>
<td width="25%">&nbsp;</td>
<td width="25%">&nbsp;</td>
<td width="25%">&nbsp;</td>
<td width="25%">&nbsp;</td>
</tr>
<tr>
<td width="25%"> Y_Y_Y_Y</td>
<td width="25%">&nbsp;</td>
<td width="25%">line 5t</td>
<td width="25%"> chroma of YV12_lines<br>
(1/8)*1t + (7/8)*5t</td>
</tr>
<tr>
<td width="25%"> C___C__</td>
<td width="25%">&nbsp;</td>
<td width="25%">&nbsp;</td>
<td width="25%">&nbsp;</td>
</tr>
<tr>
<td width="25%">&nbsp;</td>
<td width="25%"> Y_Y_Y_Y</td>
<td width="25%">line 6b</td>
<td width="25%"> chroma of YV12_lines<br>
(3/8)*4b + (5/8)*8b</td>
</tr>
<tr>
<td width="25%">&nbsp;</td>
<td width="25%">&nbsp;</td>
<td width="25%">&nbsp;</td>
<td width="25%">&nbsp;</td>
</tr>
<tr>
<td width="25%"> Y_Y_Y_Y</td>
<td width="25%">&nbsp;</td>
<td width="25%">line 7t</td>
<td width="25%"> chroma of YV12_lines<br>
(5/8)*5t + (3/8)*9t</td>
</tr>
<tr>
<td width="25%">&nbsp;</td>
<td width="25%"> C___C__</td>
<td width="25%">&nbsp;</td>
<td width="25%">&nbsp;</td>
</tr>
<tr>
<td width="25%">&nbsp;</td>
<td width="25%"> Y_Y_Y_Y</td>
<td width="25%">line 8b</td>
<td width="25%"> chroma of YV12_lines<br>
(7/8)*8b + (1/8)*12b</td>
</tr>
<tr>
<td width="25%">&nbsp;</td>
<td width="25%">&nbsp;</td>
<td width="25%">&nbsp;</td>
<td width="25%">&nbsp;</td>
</tr>
</tbody>
</table>

<p><b>Преобразование прогрессивного YV12&nbsp; -&gt; YUY2</b></p>

<p>Пропущеные (недостаюшие) отсчеты цветности интерполируются следующим образом</p>

<table border="1" width="50%">

<tbody><tr>
<td width="33%">frame</td>
<td width="33%"> line</td>
<td width="34%">weights</td>
</tr>
<tr>
<td width="33%"> Y_Y_Y_Y</td>
<td width="33%"> line 1</td>
<td width="34%"> chroma of YV12_lines<br>
1</td>
</tr>
<tr>
<td width="33%"> C___C__</td>
<td width="33%">&nbsp;</td>
<td width="34%">&nbsp;</td>
</tr>
<tr>
<td width="33%"> Y_Y_Y_Y</td>
<td width="33%"> line 2</td>
<td width="34%"> chroma of YV12_lines<br>
(0.75)*1 + (0.25)*3</td>
</tr>
<tr>
<td width="33%">&nbsp;</td>
<td width="33%">&nbsp;</td>
<td width="34%">&nbsp;</td>
</tr>
<tr>
<td width="33%"> Y_Y_Y_Y</td>
<td width="33%"> line 3</td>
<td width="34%"> chroma of YV12_lines<br>
(0.25)*1 + (0.75)*3</td>
</tr>
<tr>
<td width="33%"> C___C__</td>
<td width="33%">&nbsp;</td>
<td width="34%">&nbsp;</td>
</tr>
<tr>
<td width="33%"> Y_Y_Y_Y</td>
<td width="33%"> line 4</td>
<td width="34%"> chroma of YV12_lines<br>
(0.75)*3 + (0.25)*5</td>
</tr>
<tr>
<td width="33%">&nbsp;</td>
<td width="33%">&nbsp;</td>
<td width="34%">&nbsp;</td>
</tr>
<tr>
<td width="33%"> Y_Y_Y_Y</td>
<td width="33%"> line 5</td>
<td width="34%"> chroma of YV12_lines<br>
(0.25)*3 + (0.75)*5</td>
</tr>
<tr>
<td width="33%"> C___C__</td>
<td width="33%">&nbsp;</td>
<td width="34%">&nbsp;</td>
</tr>
<tr>
<td width="33%"> Y_Y_Y_Y</td>
<td width="33%"> line 6</td>
<td width="34%"> chroma of YV12_lines<br>
(0.75)*5 + (0.25)*7</td>
</tr>
<tr>
<td width="33%">&nbsp;</td>
<td width="33%">&nbsp;</td>
<td width="34%">&nbsp;</td>
</tr>
</tbody>
</table>

<h3>2.4 Ссылки</h3>

<p><font color="#ff0000">ColorSpaces</font><br>
[<a href="http://www.quantel.com/domisphere/infopool.nsf/HTML/dfb444?OpenDocument">4:4:4</a>] sampling<br>
[<a href="http://www.quantel.com/domisphere/infopool.nsf/HTML/dfb422?OpenDocument">4:2:2</a>] sampling<br>
[<a href="http://www.quantel.com/domisphere/infopool.nsf/HTML/dfb420?OpenDocument">4:2:0</a>] sampling<br>
[<a href="http://www.hometheaterhifi.com/volume_8_2/dvd-benchmark-special-report-chroma-bug-4-2001.html">Chroma
Upsampling</a>]<br>
[<a href="http://www.mir.com/DMG/chroma.html">Chroma Subsampling Standards</a>]</p>

<h3>3.1 Дискретизация MPEG-1 против MPEG-2</h3>

<p>Существуют два общих
варианта&nbsp;4:2:0 дискретизации (sampling). Один и них
используется в MPEG-2 видео (и стандарте CCIR-601),
а другой используется в MPEG-1.
<b>Схема MPEG-2 это как раз то, как AviSynth дискретизирует 4:2:0 видео</b>,
так как она полностью позволяет избежать горизонтального пересчета (передискретизации, resampling) в преобразованиях
4:2:0 &lt;-&gt; 4:2:2.</p>

<p>Раскладка прогрессивного MPEG-1 4:2:0 закодированного изображения</p>

<table border="1" width="50%">

<tbody><tr>
<td width="33%">frame</td>
<td width="33%"> line</td>
<td width="34%">weights</td>
</tr>
<tr>
<td width="33%"> Y_Y_Y_Y</td>
<td width="33%"> line 1</td>
<td width="34%">&nbsp;</td>
</tr>
<tr>
<td width="33%">_C__C_</td>
<td width="33%">&nbsp;</td>
<td width="34%">chroma of YUY2_lines<br>
(0.5)*1 + (0.5)*2</td>
</tr>
<tr>
<td width="33%"> Y_Y_Y_Y</td>
<td width="33%"> line 2</td>
<td width="34%">&nbsp;</td>
</tr>
<tr>
<td width="33%">&nbsp;</td>
<td width="33%">&nbsp;</td>
<td width="34%">&nbsp;</td>
</tr>
<tr>
<td width="33%"> Y_Y_Y_Y</td>
<td width="33%"> line 3</td>
<td width="34%">&nbsp;</td>
</tr>
<tr>
<td width="33%">_C__C_</td>
<td width="33%">&nbsp;</td>
<td width="34%"> chroma of YUY2_lines<br>
(0.5)*3 + (0.5)*4</td>
</tr>
<tr>
<td width="33%"> Y_Y_Y_Y</td>
<td width="33%"> line 4</td>
<td width="34%">&nbsp;</td>
</tr>
<tr>
<td width="33%">&nbsp;</td>
<td width="33%">&nbsp;</td>
<td width="34%">&nbsp;</td>
</tr>
</tbody>
</table>

<p>Раскладка&nbsp;MPEG-2 4:2:0 закодированного изображения</p>

<table border="1" width="50%">

<tbody><tr>
<td width="33%">frame</td>
<td width="33%"> line</td>
<td width="34%">weights</td>
</tr>
<tr>
<td width="33%"> Y_Y_Y_Y</td>
<td width="33%"> line 1</td>
<td width="34%">&nbsp;</td>
</tr>
<tr>
<td width="33%">C___C__</td>
<td width="33%">&nbsp;</td>
<td width="34%"> chroma of YUY2_lines<br>
(0.5)*1 + (0.5)*2</td>
</tr>
<tr>
<td width="33%"> Y_Y_Y_Y</td>
<td width="33%"> line 2</td>
<td width="34%">&nbsp;</td>
</tr>
<tr>
<td width="33%">&nbsp;</td>
<td width="33%">&nbsp;</td>
<td width="34%">&nbsp;</td>
</tr>
<tr>
<td width="33%"> Y_Y_Y_Y</td>
<td width="33%"> line 3</td>
<td width="34%">&nbsp;</td>
</tr>
<tr>
<td width="33%">C___C__</td>
<td width="33%">&nbsp;</td>
<td width="34%"> chroma of YUY2_lines<br>
(0.5)*3 + (0.5)*4</td>
</tr>
<tr>
<td width="33%"> Y_Y_Y_Y</td>
<td width="33%"> line 4</td>
<td width="34%">&nbsp;</td>
</tr>
<tr>
<td width="33%">&nbsp;</td>
<td width="33%">&nbsp;</td>
<td width="34%">&nbsp;</td>
</tr>
</tbody>
</table>

<h3>3.2 Дискретизация DV</h3>

<p>Для полноты, мы упомянем дискретизацию DV. DV является 4:2:0 (PAL) и 4:1:1 (NTSC). Заметьте, что позиции отсчетов
(sample positioning) первого отличаются от позиций 4:2:0 цветности в MPEG-1/MPEG-2!</p>

<p>Раскладка 4:2:0 закодированного изображения (основанное на полях, полукадрах, field-based)</p>

<table border="1" width="50%">

<tbody><tr>
<td width="50%">field</td>
<td width="50%"> line</td>
</tr>
<tr>
<td width="50%"> YV Y YV Y YV Y YV Y</td>
<td width="50%"> line 1</td>
</tr>
<tr>
<td width="50%"> YU Y YU Y YU Y YU Y</td>
<td width="50%"> line 2</td>
</tr>
<tr>
<td width="50%"> YV Y YV Y YV Y YV Y</td>
<td width="50%"> line 3</td>
</tr>
<tr>
<td width="50%"> YU Y YU Y YU Y YU Y</td>
<td width="50%"> line 4</td>
</tr>
</tbody>
</table>

<p>Раскладка 4:1:1 закодированного изображения (основанное на полях, полукадрах, field-based)</p>

<table border="1" width="50%">

<tbody><tr>
<td width="50%">field</td>
<td width="50%"> line</td>
</tr>
<tr>
<td width="50%"> YC Y Y Y YC Y Y Y&nbsp;</td>
<td width="50%"> line 1</td>
</tr>
<tr>
<td width="50%"> YC Y Y Y YC Y Y Y&nbsp;</td>
<td width="50%"> line 2</td>
</tr>
<tr>
<td width="50%"> YC Y Y Y YC Y Y Y&nbsp;</td>
<td width="50%"> line 3</td>
</tr>
<tr>
<td width="50%"> YC Y Y Y YC Y Y Y&nbsp;</td>
<td width="50%"> line 4</td>
</tr>
</tbody>
</table>

<p>Некоторые комментарии об этих форматах:<br>
- 4:1:1 прямо (врожденно, natively) поддерживается в AviSynth только с версии 2.6.<br>
- Все DV декодеры выводят YUY2 или RGB (за исключением ffdshow если разрешено YV12).<br>
- При выводе YUY2/RGB (NTSC), кодек MainConcept дублирует цветовые отсчеты вместо их интерполяции. Плагин
[<a href="http://mywebpages.comcast.net/trbarry/downloads.htm">ReInterpolate411
plugin</a>] может быть использован, чтобы скорректировать это, приводя к лучшему качеству.</p>

<h3>3.3 Ссылки</h3>

<p>[<a href="http://http://msdn.microsoft.com/library/default.asp?url=/library/en-us/dnwmt/html/YUVFormats.asp">MSDN:
YUV sampling</a>] Описывает большинство общих методов&nbsp;YUV дискретизации.<br>
[<a href="http://www.adamwilt.com/pix-sampling.html">DV sampling</a>]</p>

<h2>4.&nbsp;Проблема 4:2:0 чересстрочной цветности (Interlaced Chroma Problem&nbsp;or ICP)</h2>

<p>Вообще, чересстрочный контент
(содержимое)&nbsp;&nbsp;имеет и статические части. Если они
пересчитаны к высокому разрешению (upsampled) корректно, используя
чересстрочный пересчет, они все же имеют <i>проблемы цветности на диагональных краях ярко-окрашенных объектов в статических частях кадра</i>.
Причиной является то, что "Когда два поля потом
складываются&nbsp; деинтерлейсом (или Вашим глазом и мозгом, если
вы смотрите это на чересстрочном телевизоре), то относительно плавные
градации и контуры каждого поля ломаются (разбиваются, broken up)
слегка отличающимся набором градаций и контуров от другого поля."
(цитировано из первой ссылки). Это называется
<b>Проблемой чересстрочной цветности (the Interlaced Chroma Problem)</b>.
 "Решением" является адаптивный к движению пересчет разрешения, но фильтра
AviSynth/VDub, который пытался бы сделать это, пока не существует.</p>

<p>Ссылки:<br>
[<a href="http://www.hometheaterhifi.com/volume_8_2/dvd-benchmark-special-report-chroma-bug-4-2001.html">
The 4:2:0 Interlaced Chroma Problem</a>]<br>
[<a href="http://members.aol.com/ajaynejr/vidbug2.htm">The 4:2:0 Interlaced Chroma Problem - Television and Video Advice</a>]</p>

<p><kbd>$English Date: 2007/08/22 20:51:38 $<br>
Русский перевод 28.05.2005-26.08.2007 Fizick http://bag.hotmail.ru</kbd></p>

<form><input value="Back" onclick="history.go(-1)" type="button"></form>

</body></html>